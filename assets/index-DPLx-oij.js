import{_ as ue,k as S,s as me,j as C,o as f,w as a,d as n,l as L,q as se,t as r,v as T,x as ne,y as k,z as Y,i as o,A as x,B as _,C as b,D as Qt,F as z,E as oe,T as $e,G as O,e as ae,H as de,I as ee,n as X,J as we,K as Se,L as Ge,M as fe,N as st,O as nt,P as Ie,R as ke,Q as Xt,S as Zt,g as Fe,p as Ne,U as es,W as E,X as ye,Y as ts,Z as ss,$ as Ue,a0 as ns,a1 as K,a2 as be,a3 as at,a4 as as,c as Re,a5 as ls,a6 as Ke,a7 as Ae,a8 as is,a9 as os,aa as vt,ab as rs,ac as ds,ad as lt,ae as us,af as it,ag as pt,ah as gt,ai as cs,aj as ms,ak as ot,al as fs,am as hs,an as kt,ao as yt,ap as bt,h as Ye,aq as xt,u as vs,ar as ze,m as wt,f as ps,as as gs,at as ks,au as ys,av as bs,aw as ce,ax as xs,ay as ws,az as Ss,aA as Cs,aB as De,aC as Oe,r as Ds,aD as Vs,aE as Ts,aF as _s,aG as Ve,aH as rt}from"./index-7IYGOfs0.js";import{V as ve,u as Ls,m as Is}from"./VTextField-TzCBebGx.js";import{V as We}from"./VTooltip-3DlUeZDM.js";import{V as q}from"./VChip-C6nGT8tD.js";import{g as He,j as qe,o as St,a as zs,l as Ps}from"./socketClient-BV35oUdJ.js";import{V as As}from"./VBadge-bFJYee0X.js";import{V as Je}from"./VTextarea-BgizTKUS.js";import{V as Ct}from"./VMenu-DJWnpkEy.js";import{V as Fs}from"./VDatePicker-DiggL-XN.js";import{_ as Dt,p as dt}from"./index-DtMufIQI.js";import{d as Ce}from"./dataProvider-DRMTFwsF.js";import{a as Te,g as Ns}from"./axios-B7NKhyp9.js";import{u as Rs,a as Es,b as Bs,V as Ms,h as js,m as Us,c as Os}from"./filter-DgECVsLP.js";import{V as $s}from"./VCheckboxBtn-Km17YzJ6.js";import{V as Ee}from"./VAlert-Df0K8Bdx.js";import{V as Pe,a as xe}from"./VRow-CZv9s28d.js";import{V as Ks,a as ut,b as ct,c as mt}from"./VExpansionPanels-COZa8xEg.js";import{V as Hs,a as qs}from"./VAppBarTitle-BgUJGKoV.js";import{V as Gs}from"./VContainer-CyLU9AUY.js";const Ys={name:"RandomPicker",props:{studentList:{type:Array,required:!0},attendance:{type:Object,required:!0,default:()=>({absent:[],late:[],exclude:[]})}},data(){return{dialog:!1,count:S("randomPicker.defaultCount"),isPickingStarted:!1,isAnimating:!1,pickedStudents:[],animationStudents:[],highlightedIndices:[],animationTimer:null,getSetting:S,tempFilters:{excludeAbsent:S("randomPicker.excludeAbsent"),excludeLate:S("randomPicker.excludeLate"),excludeExcluded:S("randomPicker.excludeExcluded")},pickerMode:S("randomPicker.mode"),minNumber:S("randomPicker.minNumber"),maxNumber:S("randomPicker.maxNumber")}},computed:{absentCount(){return this.attendance.absent?this.attendance.absent.length:0},lateCount(){return this.attendance.late?this.attendance.late.length:0},excludedCount(){return this.attendance.exclude?this.attendance.exclude.length:0},numberModeStudents(){if(this.pickerMode!=="number")return[];const t=[];for(let e=this.minNumber;e<=this.maxNumber;e++)t.push(e.toString().padStart(2,"0")+"号");return t},filteredStudents(){return this.pickerMode==="number"?this.numberModeStudents:!this.studentList||!this.studentList.length?[]:this.studentList.filter(t=>!(this.tempFilters.excludeAbsent&&this.attendance.absent.includes(t)||this.tempFilters.excludeLate&&this.attendance.late.includes(t)||this.tempFilters.excludeExcluded&&this.attendance.exclude.includes(t)))},availableStudents(){return this.filteredStudents},maxAllowedCount(){return Math.min(10,this.filteredStudents.length)},remainingStudents(){return this.filteredStudents.filter(t=>!this.pickedStudents.includes(t))}},watch:{dialog(t){t?(this.count=S("randomPicker.defaultCount"),this.isPickingStarted=!1,this.isAnimating=!1,this.pickedStudents=[],this.tempFilters={excludeAbsent:S("randomPicker.excludeAbsent"),excludeLate:S("randomPicker.excludeLate"),excludeExcluded:S("randomPicker.excludeExcluded")}):this.animationTimer&&(clearTimeout(this.animationTimer),this.animationTimer=null)},tempFilters:{handler(){this.count>this.maxAllowedCount&&(this.count=Math.max(1,this.maxAllowedCount))},deep:!0},pickerMode:{handler(t){me("randomPicker.mode",t)}},minNumber:{handler(t){t>this.maxNumber&&(this.minNumber=this.maxNumber),t<1&&(this.minNumber=1),me("randomPicker.minNumber",this.minNumber)}},maxNumber:{handler(t){t<this.minNumber&&(this.maxNumber=this.minNumber),t>100&&(this.maxNumber=100),me("randomPicker.maxNumber",this.maxNumber)}}},methods:{open(){this.dialog=!0},incrementCount(){this.count<this.maxAllowedCount&&this.count++},decrementCount(){this.count>1&&this.count--},startPicking(){this.filteredStudents.length!==0&&(this.isPickingStarted=!0,S("randomPicker.animation")?this.startAnimation():this.finishPicking())},startAnimation(){this.isAnimating=!0,this.animationStudents=this.filteredStudents.map((t,e)=>({id:`student-${e}`,name:t})),this.animateHighlight()},animateHighlight(){let e=0;const l=50,u=()=>{this.highlightedIndices=[];const s=[];for(let c=0;c<this.count;c++){let m;do m=Math.floor(Math.random()*this.animationStudents.length);while(s.includes(m));s.push(m)}this.highlightedIndices=s,e++;const i=l+e*20;e<5?this.animationTimer=setTimeout(u,i):setTimeout(()=>{this.finishPicking()},500)};u()},finishPicking(){this.isAnimating=!1;const t=[...this.filteredStudents].sort(()=>.5-Math.random());this.pickedStudents=t.slice(0,this.count)},resetPicker(){this.isPickingStarted=!1,this.isAnimating=!1,this.pickedStudents=[],this.animationTimer&&(clearTimeout(this.animationTimer),this.animationTimer=null)},refreshSingleStudent(t){if(this.remainingStudents.length===0)return;const e=Math.floor(Math.random()*this.remainingStudents.length),l=this.remainingStudents[e];this.pickedStudents[t]=l;const u=document.querySelectorAll(".result-card");u[t]&&(u[t].classList.add("refresh-animation"),setTimeout(()=>{u[t].classList.remove("refresh-animation")},500))}}},Ws={class:"d-flex justify-center align-center counter-container"},Js={class:"count-display mx-8"},Qs={class:"text-h2 font-weight-bold"},Xs={class:"mode-switch-container mt-6"},Zs={key:0,class:"number-range-container mt-4"},en={class:"d-flex justify-center align-center gap-4"},tn={class:"mt-4"},sn={key:1,class:"mt-4 text-error"},nn={class:"mt-4 text-caption"},an={class:"pa-2"},ln={key:0},on={key:1},rn={key:2},dn={key:1,class:"d-flex flex-wrap justify-center gap-2 mt-4"},un={key:0,class:"animation-container"},cn={class:"animation-wrapper"},mn={key:1,class:"result-container"},fn={class:"mt-8 d-flex justify-center"};function hn(t,e,l,u,s,i){return f(),C(de,{modelValue:s.dialog,"onUpdate:modelValue":e[8]||(e[8]=c=>s.dialog=c),"max-width":"600","fullscreen-breakpoint":"sm",persistent:""},{default:a(()=>[n(L,{class:"random-picker-card",rounded:"xl",border:""},{default:a(()=>[n(se,{class:"text-h5 d-flex align-center"},{default:a(()=>[n(T,{icon:"mdi-account-question",class:"mr-2"}),e[9]||(e[9]=r(" 随机点名 ",-1)),n(ne),n(k,{icon:"mdi-close",variant:"text",onClick:e[0]||(e[0]=c=>s.dialog=!1)})]),_:1}),s.isPickingStarted?(f(),C(Y,{key:1,class:"text-center py-6"},{default:a(()=>[s.isAnimating?(f(),x("div",un,[o("div",cn,[n($e,{name:"shuffle",tag:"div",class:"shuffle-container"},{default:a(()=>[(f(!0),x(z,null,O(s.animationStudents,(c,m)=>(f(),x("div",{key:c.id,class:ae(["student-item",{highlighted:s.highlightedIndices.includes(m)}])},b(c.name),3))),128))]),_:1})])])):(f(),x("div",mn,[e[19]||(e[19]=o("div",{class:"text-h6 mb-4"},"抽取结果",-1)),(f(!0),x(z,null,O(s.pickedStudents,(c,m)=>(f(),C(L,{key:m,variant:"outlined",color:"primary",class:"mb-2 result-card"},{default:a(()=>[n(Y,{class:"text-h4 text-center py-4 d-flex align-center justify-center"},{default:a(()=>[r(b(c)+" ",1),n(k,{icon:"mdi-refresh",variant:"text",size:"small",class:"ml-2 refresh-btn",onClick:p=>i.refreshSingleStudent(m),disabled:i.remainingStudents.length===0,title:i.remainingStudents.length===0?"没有更多可用学生":"重新抽取此学生"},null,8,["onClick","disabled","title"])]),_:2},1024)]),_:2},1024))),128)),o("div",fn,[n(k,{color:"primary","prepend-icon":"mdi-refresh",onClick:i.resetPicker,size:"large",class:"mx-2"},{default:a(()=>[...e[17]||(e[17]=[r(" 重新抽取 ",-1)])]),_:1},8,["onClick"]),n(k,{color:"grey",variant:"outlined",onClick:e[7]||(e[7]=c=>s.dialog=!1),size:"large",class:"mx-2"},{default:a(()=>[...e[18]||(e[18]=[r(" 关闭 ",-1)])]),_:1})])]))]),_:1})):(f(),C(Y,{key:0,class:"text-center py-6"},{default:a(()=>[e[16]||(e[16]=o("div",{class:"text-h6 mb-4"},"请选择抽取人数",-1)),o("div",Ws,[n(k,{size:"x-large",icon:"mdi-minus",variant:"tonal",color:"primary",disabled:s.count<=1,onClick:i.decrementCount,class:"counter-btn"},null,8,["disabled","onClick"]),o("div",Js,[o("span",Qs,b(s.count),1),e[10]||(e[10]=o("span",{class:"text-subtitle-1 ml-2"},"人",-1))]),n(k,{size:"x-large",icon:"mdi-plus",variant:"tonal",color:"primary",disabled:s.count>=i.maxAllowedCount,onClick:i.incrementCount,class:"counter-btn"},null,8,["disabled","onClick"])]),o("div",Xs,[n(Qt,{modelValue:s.pickerMode,"onUpdate:modelValue":e[1]||(e[1]=c=>s.pickerMode=c),color:"primary",rounded:"pill",mandatory:"",class:"mode-toggle"},{default:a(()=>[n(k,{value:"name","prepend-icon":"mdi-account"},{default:a(()=>[...e[11]||(e[11]=[r("姓名模式",-1)])]),_:1}),n(k,{value:"number","prepend-icon":"mdi-numeric"},{default:a(()=>[...e[12]||(e[12]=[r("学号模式",-1)])]),_:1})]),_:1},8,["modelValue"])]),s.pickerMode==="number"?(f(),x("div",Zs,[e[14]||(e[14]=o("div",{class:"text-subtitle-1 mb-2"},"学号范围设置",-1)),o("div",en,[n(ve,{modelValue:s.minNumber,"onUpdate:modelValue":e[2]||(e[2]=c=>s.minNumber=c),modelModifiers:{number:!0},label:"最小值",type:"number",min:"1",max:"100","hide-details":"",class:"number-input",density:"compact"},null,8,["modelValue"]),e[13]||(e[13]=o("span",{class:"mx-2"},"至",-1)),n(ve,{modelValue:s.maxNumber,"onUpdate:modelValue":e[3]||(e[3]=c=>s.maxNumber=c),modelModifiers:{number:!0},label:"最大值",type:"number",min:"1",max:"100","hide-details":"",class:"number-input",density:"compact"},null,8,["modelValue"])])])):_("",!0),o("div",tn,[n(k,{size:"x-large",color:"primary","prepend-icon":"mdi-dice-multiple",onClick:i.startPicking,disabled:i.filteredStudents.length===0,class:"start-btn"},{default:a(()=>[...e[15]||(e[15]=[r(" 开始抽取 ",-1)])]),_:1},8,["onClick","disabled"])]),i.filteredStudents.length===0?(f(),x("div",sn,[s.pickerMode==="name"?(f(),x(z,{key:0},[r(" 没有可抽取的学生，请调整过滤选项 ")],64)):(f(),x(z,{key:1},[r(" 请设置有效的学号范围 ")],64))])):_("",!0),o("div",nn,[r(" 当前可抽取学生: "+b(i.filteredStudents.length)+"人 ",1),s.pickerMode==="name"?(f(),C(We,{key:0,location:"bottom"},{activator:a(({props:c})=>[n(T,oe(c,{icon:"mdi-information-outline",size:"small",class:"ml-1"}),null,16)]),default:a(()=>[o("div",an,[s.tempFilters.excludeAbsent?(f(),x("div",ln," • 已排除请假学生 ("+b(i.absentCount)+"人) ",1)):_("",!0),s.tempFilters.excludeLate?(f(),x("div",on," • 已排除迟到学生 ("+b(i.lateCount)+"人) ",1)):_("",!0),s.tempFilters.excludeExcluded?(f(),x("div",rn," • 已排除不参与学生 ("+b(i.excludedCount)+"人) ",1)):_("",!0)])]),_:1})):_("",!0),s.pickerMode==="name"?(f(),x("div",dn,[n(q,{color:s.tempFilters.excludeLate?"warning":"default",variant:s.tempFilters.excludeLate?"elevated":"text",onClick:e[4]||(e[4]=c=>s.tempFilters.excludeLate=!s.tempFilters.excludeLate),"prepend-icon":"mdi-clock-alert",class:"filter-chip"},{default:a(()=>[r(b(s.tempFilters.excludeLate?"排除":"包含")+"迟到学生 ",1)]),_:1},8,["color","variant"]),n(q,{color:s.tempFilters.excludeAbsent?"error":"default",variant:s.tempFilters.excludeAbsent?"elevated":"text",onClick:e[5]||(e[5]=c=>s.tempFilters.excludeAbsent=!s.tempFilters.excludeAbsent),"prepend-icon":"mdi-account-off",class:"filter-chip"},{default:a(()=>[r(b(s.tempFilters.excludeAbsent?"排除":"包含")+"请假学生 ",1)]),_:1},8,["color","variant"]),n(q,{color:s.tempFilters.excludeExcluded?"grey":"default",variant:s.tempFilters.excludeExcluded?"elevated":"text",onClick:e[6]||(e[6]=c=>s.tempFilters.excludeExcluded=!s.tempFilters.excludeExcluded),"prepend-icon":"mdi-account-cancel",class:"filter-chip"},{default:a(()=>[r(b(s.tempFilters.excludeExcluded?"排除":"包含")+"不参与学生 ",1)]),_:1},8,["color","variant"])])):_("",!0)])]),_:1}))]),_:1})]),_:1},8,["modelValue"])}const Vt=ue(Ys,[["render",hn],["__scopeId","data-v-fd7ac224"]]),vn={name:"ChatWidget",props:{modelValue:{type:Boolean,default:!1},showButton:{type:Boolean,default:!0},offset:{type:Number,default:16},width:{type:Number,default:380},height:{type:Number,default:520}},emits:["update:modelValue"],data(){return{visible:this.modelValue,text:"",messages:[],lastVisit:null,unreadCount:0,connected:!1,socketId:""}},computed:{panelStyle(){return{right:this.offset+"px",bottom:this.offset+"px",width:this.width+"px",height:this.height+"px"}},toggleStyle(){return{right:this.offset+"px",bottom:this.offset+"px"}},canSend(){return!!(S("server.kvToken")&&this.text.trim())},showToggleButton(){return this.$props.showButton&&!this.visible},decoratedMessages(){if(!this.lastVisit)return this.messages;const t=this.messages.findIndex(u=>u.at&&new Date(u.at).getTime()>=new Date(this.lastVisit).getTime());if(t<=0)return this.messages;const e=this.messages.slice(0,t),l=this.messages.slice(t);return[...e,{_id:"divider",_type:"divider"},...l]}},watch:{modelValue(t){this.visible=t,t&&this.onOpen()}},mounted(){try{const l=localStorage.getItem("chat.lastVisit");l&&(this.lastVisit=l)}catch{}const t=He();this.connected=!!t.connected,this.socketId=t.id||"",t.on("connect",()=>{this.connected=!0,this.socketId=t.id||""}),t.on("disconnect",()=>{this.connected=!1});const e=S("server.kvToken");e&&qe(e),this.offMessage=St("chat:message",l=>{this.pushMessage(l)}),this.visible&&this.onOpen()},beforeUnmount(){this.offMessage&&this.offMessage()},methods:{open(){this.visible=!0,this.$emit("update:modelValue",!0),this.onOpen()},close(){this.visible=!1,this.$emit("update:modelValue",!1);try{localStorage.setItem("chat.lastVisit",new Date().toISOString())}catch{}this.unreadCount=0},onOpen(){this.$nextTick(()=>this.scrollToBottom())},insertEmoji(t){this.text+=t,this.$nextTick(()=>{var e,l;if((l=(e=this.$refs.inputRef)==null?void 0:e.$el)!=null&&l.querySelector){const u=this.$refs.inputRef.$el.querySelector("textarea");u==null||u.focus()}})},handleEnter(t){t.shiftKey||this.send()},send(){const t=this.text.trim();if(!t)return;He().emit("chat:send",t),this.text=""},pushMessage(t){const e={_id:`${t.at||Date.now()}-${Math.random()}`,text:typeof(t==null?void 0:t.text)=="string"?t.text:(t==null?void 0:t.text)||"",at:t.at||new Date().toISOString(),senderId:t.senderId,self:!!(t.senderId&&t.senderId===this.socketId)};e.text&&(this.messages.push(e),this.visible||this.unreadCount++,this.$nextTick(()=>this.scrollToBottom()),this.messages.length>500&&this.messages.shift())},formatTime(t){try{const e=new Date(t),l=String(e.getHours()).padStart(2,"0"),u=String(e.getMinutes()).padStart(2,"0");return`${l}:${u}`}catch{return""}},scrollToBottom(){const t=this.$refs.listRef;if(t)try{t.scrollTop=t.scrollHeight}catch{}}}},pn={ref:"listRef",class:"messages"},gn={key:0,class:"divider-row"},kn={class:"avatar"},yn={class:"bubble"},bn={class:"text"},xn={class:"meta"};function wn(t,e,l,u,s,i){return f(),x(z,null,[i.showToggleButton?(f(),x("div",{key:0,class:"chat-toggle",style:X(i.toggleStyle)},[n(k,{icon:"",color:"primary",variant:"flat",onClick:e[0]||(e[0]=c=>i.open())},{default:a(()=>[n(As,{content:s.unreadCount||void 0,"model-value":s.unreadCount>0,color:"error",overlap:""},{default:a(()=>[n(T,null,{default:a(()=>[...e[5]||(e[5]=[r(" mdi-chat ",-1)])]),_:1})]),_:1},8,["content","model-value"])]),_:1})],4)):_("",!0),ee(o("div",{class:"chat-panel",style:X(i.panelStyle)},[n(L,{border:"",elevation:"8",class:"chat-card"},{default:a(()=>[n(se,{class:"d-flex align-center"},{default:a(()=>[n(T,{class:"mr-2"},{default:a(()=>[...e[6]||(e[6]=[r(" mdi-chat-processing ",-1)])]),_:1}),e[8]||(e[8]=o("span",{class:"text-subtitle-1"},"设备聊天室",-1)),n(ne),n(We,{location:"top"},{activator:a(({props:c})=>[n(q,oe(c,{size:"x-small",color:s.connected?"success":"grey",variant:"tonal"}),{default:a(()=>[r(b(s.connected?"已连接":"未连接"),1)]),_:1},16,["color"])]),default:a(()=>[o("span",null,"Socket "+b(s.socketId||"-"),1)]),_:1}),n(k,{icon:"",variant:"text",onClick:e[1]||(e[1]=c=>i.close())},{default:a(()=>[n(T,null,{default:a(()=>[...e[7]||(e[7]=[r("mdi-close",-1)])]),_:1})]),_:1})]),_:1}),n(Se),n(Y,{class:"chat-body"},{default:a(()=>[o("div",pn,[(f(!0),x(z,null,O(i.decoratedMessages,c=>(f(),x(z,{key:c._id},[c._type==="divider"?(f(),x("div",gn,[n(Se,{class:"my-2"}),e[9]||(e[9]=o("div",{class:"divider-text"}," 今天 - 上次访问 ",-1)),n(Se,{class:"my-2"})])):(f(),x("div",{key:1,class:ae(["message-row",{self:c.self}])},[o("div",kn,[n(Ge,{size:"24",color:c.self?"primary":"grey"},{default:a(()=>[n(T,{size:"small"},{default:a(()=>[r(b(c.self?"mdi-account":"mdi-account-outline"),1)]),_:2},1024)]),_:2},1032,["color"])]),o("div",yn,[o("div",bn,b(c.text),1),o("div",xn,b(i.formatTime(c.at)),1)])],2))],64))),128))],512)]),_:1}),n(Se),n(fe,{class:"chat-input"},{default:a(()=>[n(k,{icon:"",variant:"text",class:"mr-1",onClick:e[2]||(e[2]=c=>i.insertEmoji("😄"))},{default:a(()=>[n(T,null,{default:a(()=>[...e[10]||(e[10]=[r("mdi-emoticon-outline",-1)])]),_:1})]),_:1}),n(Je,{ref:"inputRef",modelValue:s.text,"onUpdate:modelValue":e[3]||(e[3]=c=>s.text=c),class:"flex-grow-1",rows:"1","auto-grow":"",variant:"solo","hide-details":"",placeholder:"输入消息",onKeydown:[st(nt(i.handleEnter,["prevent"]),["enter"]),e[4]||(e[4]=st(nt(()=>{},["shift","stop"]),["enter"]))]},null,8,["modelValue","onKeydown"]),n(k,{color:"primary",disabled:!i.canSend,class:"ml-2",onClick:i.send},{default:a(()=>[n(T,{start:""},{default:a(()=>[...e[11]||(e[11]=[r(" mdi-send ",-1)])]),_:1}),e[12]||(e[12]=r(" 发送 ",-1))]),_:1},8,["disabled","onClick"])]),_:1})]),_:1})],4),[[we,s.visible]])],64)}const Tt=ue(vn,[["render",wn],["__scopeId","data-v-310a7af6"]]),Sn={name:"FloatingICP"},Cn={class:"floating-icp-link",href:"https://beian.miit.gov.cn/",target:"_blank",rel:"noopener noreferrer","aria-label":"浙ICP备2024068645号"};function Dn(t,e,l,u,s,i){return f(),x("a",Cn," 浙ICP备2024068645号 ")}const _t=ue(Sn,[["render",Dn],["__scopeId","data-v-5eff4b5c"]]),Vn={name:"FloatingToolbar",props:{loading:{type:Boolean,default:!1},unreadCount:{type:Number,default:0},selectedDate:{type:[String,Date],required:!0},isToday:{type:Boolean,required:!0}},data(){return{isExpanded:!1}},methods:{handleDateSelect(t){this.$emit("date-select",t)}}};function Tn(t,e,l,u,s,i){return f(),C(Xt,null,{default:a(()=>[n(L,{class:ae(["floating-toolbar",{"toolbar-expanded":s.isExpanded}]),elevation:"4",rounded:"xl"},{default:a(()=>[n(Ie,{variant:"text",class:"toolbar-buttons"},{default:a(()=>[ee(n(k,{icon:"mdi-chevron-left",variant:"text",onClick:e[0]||(e[0]=c=>t.$emit("prev-day")),title:"查看昨天",class:"toolbar-btn"},null,512),[[ke]]),ee(n(k,{icon:"mdi-format-font-size-decrease",variant:"text",onClick:e[1]||(e[1]=c=>t.$emit("zoom","out")),title:"缩小字体",class:"toolbar-btn"},null,512),[[ke]]),ee(n(k,{icon:"mdi-format-font-size-increase",variant:"text",onClick:e[2]||(e[2]=c=>t.$emit("zoom","up")),title:"放大字体",class:"toolbar-btn"},null,512),[[ke]]),n(Ct,{location:"top","close-on-content-click":!1},{activator:a(({props:c})=>[ee(n(k,oe({icon:"mdi-calendar",variant:"text"},c,{title:"选择日期",class:"toolbar-btn"}),null,16),[[ke]])]),default:a(()=>[n(L,{border:"",class:"date-picker-card"},{default:a(()=>[n(Fs,{"model-value":l.selectedDate,color:"primary","onUpdate:modelValue":i.handleDateSelect},null,8,["model-value","onUpdate:modelValue"])]),_:1})]),_:1}),ee(n(k,{icon:"mdi-refresh",variant:"text",loading:l.loading,onClick:e[3]||(e[3]=c=>t.$emit("refresh")),title:"刷新数据",class:"toolbar-btn"},null,8,["loading"]),[[ke]]),l.isToday?_("",!0):ee((f(),C(k,{key:0,icon:"mdi-chevron-right",variant:"text",onClick:e[4]||(e[4]=c=>t.$emit("next-day")),title:"查看明天",class:"toolbar-btn"},null,512)),[[ke]])]),_:1})]),_:1},8,["class"])]),_:1})}const Lt=ue(Vn,[["render",Tn],["__scopeId","data-v-4c0541bf"]]),_n={name:"HomeworkEditDialog",props:{modelValue:{type:Boolean,required:!0},title:{type:String,required:!0},initialContent:{type:String,default:""},autoSave:{type:Boolean,default:!1}},emits:["update:modelValue","save"],data(){return{content:"",templateData:null,currentLine:"",currentLineStart:0,currentLineEnd:0,quickTexts:["课","题","例","变","T","P"]}},computed:{dialogVisible:{get(){return this.modelValue},set(t){this.$emit("update:modelValue",t)}},subject(){return this.title},hasTemplates(){var t,e;return!!((e=(t=this.templateData)==null?void 0:t.actions)!=null&&e.length||this.subjectBooks||this.commonBooks)},subjectBooks(){var t,e,l;return!this.subject||!((l=(e=(t=this.templateData)==null?void 0:t.subjects)==null?void 0:e[this.subject])!=null&&l.books)?null:this.templateData.subjects[this.subject].books},commonBooks(){var t,e;return(e=(t=this.templateData)==null?void 0:t.commonSubject)!=null&&e.books?this.templateData.commonSubject.books:null},showQuickTools(){return S("display.showQuickTools")}},watch:{async modelValue(t){if(t){this.content=this.initialContent;try{this.templateData=await Ce.loadData("classworks-config-homework-template")}catch(e){console.error("Failed to load homework templates:",e),this.templateData=null}this.$nextTick(()=>{this.$refs.inputRef&&(this.$refs.inputRef.focus(),this.updateCurrentLine())})}}},methods:{handleClose(){const t=this.content.trim();t!==this.initialContent.trim()&&this.$emit("save",t),this.dialogVisible=!1},updateCurrentLine(){const e=this.$refs.inputRef.$el.querySelector("textarea").selectionStart,l=this.content;let u=0;const s=l.split(`
`);for(let i=0;i<s.length;i++){const c=s[i].length,m=u+c;if(e<=m||i===s.length-1){this.currentLine=s[i],this.currentLineStart=u,this.currentLineEnd=m;break}u=m+1}this.currentLine||(this.currentLine="",this.currentLineStart=l.length,this.currentLineEnd=l.length)},isBookSelected(t){return this.currentLine.includes(t)},isPageSelected(t,e){return this.currentLine.includes(e)},handleBookClick(t){if(this.isBookSelected(t)){const e=this.content.split(`
`),l=e.findIndex(u=>u.includes(t));l!==-1&&(e.splice(l,1),this.content=e.join(`
`))}else{const e=this.content.trim().length>0;this.content=(e?this.content.trim()+`
`:"")+t}this.$nextTick(()=>{const e=this.$refs.inputRef.$el.querySelector("textarea");if(e.focus(),!this.isBookSelected(t)){const l=this.content.split(`
`);let u=0;for(let s=0;s<l.length;s++){if(l[s].includes(t)){u+=l[s].length;break}u+=l[s].length+1}e.setSelectionRange(u,u)}this.updateCurrentLine()})},handlePageClick(t,e){if(this.isPageSelected(t,e)){const l=this.currentLineStart,u=this.currentLineEnd,s=this.content.slice(l,u),i=s.lastIndexOf(e);if(i!==-1){const c=s.slice(0,i)+s.slice(i+e.length);this.content=this.content.slice(0,l)+c.trim()+this.content.slice(u)}}else{const l=this.currentLineStart,u=this.currentLineEnd,s=this.content.slice(l,u);this.content=this.content.slice(0,l)+s.trim()+(s.trim().length>0?" ":"")+e+this.content.slice(u)}this.$nextTick(()=>{const l=this.$refs.inputRef.$el.querySelector("textarea");l.focus();const u=this.content.split(`
`);let s=0;for(let i=0;i<u.length&&(s+=u[i].length,!(s>this.currentLineStart));i++)s+=1;l.setSelectionRange(s,s),this.updateCurrentLine()})},insertTemplate(t){const e=this.$refs.inputRef.$el.querySelector("textarea"),l=e.selectionStart,u=e.selectionEnd,s=l>0&&this.content[l-1]!==" "&&this.content[l-1]!==`
`;this.content=this.content.slice(0,l)+(s?" ":"")+t+this.content.slice(u),this.$nextTick(()=>{e.focus();const i=l+t.length+(s?1:0);e.setSelectionRange(i,i),this.updateCurrentLine()})},insertAtCursor(t){if(!t)return;const e=this.$refs.inputRef.$el.querySelector("textarea"),l=e.selectionStart,u=e.selectionEnd;this.content=this.content.slice(0,l)+t+this.content.slice(u),this.$nextTick(()=>{e.focus();const s=l+t.length;e.setSelectionRange(s,s),this.updateCurrentLine()})},deleteLastChar(){const t=this.$refs.inputRef.$el.querySelector("textarea"),e=t.selectionStart,l=t.selectionEnd;e===l?e>0&&(this.content=this.content.slice(0,e-1)+this.content.slice(e),this.$nextTick(()=>{t.focus(),t.setSelectionRange(e-1,e-1),this.updateCurrentLine()})):(this.content=this.content.slice(0,e)+this.content.slice(l),this.$nextTick(()=>{t.focus(),t.setSelectionRange(e,e),this.updateCurrentLine()}))}}},Ln={class:"d-flex"},In={class:"flex-grow-1"},zn={key:0,class:"mt-4"},Pn={key:0,class:"template-buttons"},An={key:0,class:"pages-container mt-2"},Fn={key:0,class:"pages-container mt-2"},Nn={key:2,class:"button-group"},Rn={key:1,class:"text-center text-body-2 text-disabled mt-2"},En={key:0,class:"quick-tools ml-4",style:{"min-width":"180px"}},Bn={class:"numeric-keypad mb-4"},Mn={class:"keypad-row"},jn={class:"keypad-row"},Un={class:"keypad-row"},On={class:"keypad-row"},$n={class:"keypad-row"},Kn={class:"d-flex flex-wrap gap-1"};function Hn(t,e,l,u,s,i){return f(),C(de,{modelValue:i.dialogVisible,"onUpdate:modelValue":e[5]||(e[5]=c=>i.dialogVisible=c),width:"auto","max-width":"900","onClick:outside":i.handleClose},{default:a(()=>[n(L,{border:""},{default:a(()=>[n(se,null,{default:a(()=>[r(b(l.title),1)]),_:1}),n(Zt,null,{default:a(()=>[r(b(l.autoSave?"喵？喵呜！":"写完后点击上传谢谢喵"),1)]),_:1}),n(Y,null,{default:a(()=>{var c;return[o("div",Ln,[o("div",In,[n(Je,{ref:"inputRef",modelValue:s.content,"onUpdate:modelValue":e[0]||(e[0]=m=>s.content=m),"auto-grow":"",placeholder:"使用换行表示分条",rows:"5",onClick:i.updateCurrentLine,onKeyup:i.updateCurrentLine,width:"480"},null,8,["modelValue","onClick","onKeyup"]),s.templateData?(f(),x("div",zn,[i.hasTemplates?(f(),x("div",Pn,[i.subjectBooks?(f(!0),x(z,{key:0},O(i.subjectBooks,(m,p)=>(f(),x("div",{key:p,class:"button-group"},[n(q,{class:"ma-1 book-chip",color:i.isBookSelected(p)?"success":"default",variant:i.isBookSelected(p)?"elevated":"flat",onClick:v=>i.handleBookClick(p)},{default:a(()=>[r(b(p),1)]),_:2},1032,["color","variant","onClick"]),i.isBookSelected(p)?(f(),x("div",An,[(f(!0),x(z,null,O(m,v=>(f(),C(q,{key:v,class:"ma-1",color:i.isPageSelected(p,v)?"info":"default",variant:i.isPageSelected(p,v)?"elevated":"flat",onClick:y=>i.handlePageClick(p,v)},{default:a(()=>[r(b(v),1)]),_:2},1032,["color","variant","onClick"]))),128))])):_("",!0)]))),128)):_("",!0),i.commonBooks?(f(!0),x(z,{key:1},O(i.commonBooks,(m,p)=>(f(),x("div",{key:p,class:"button-group"},[n(q,{class:"ma-1 book-chip",color:i.isBookSelected(p)?"success":"default",variant:i.isBookSelected(p)?"elevated":"flat",onClick:v=>i.handleBookClick(p)},{default:a(()=>[r(b(p),1)]),_:2},1032,["color","variant","onClick"]),i.isBookSelected(p)?(f(),x("div",Fn,[(f(!0),x(z,null,O(m,v=>(f(),C(q,{key:v,class:"ma-1",color:i.isPageSelected(p,v)?"info":"default",variant:i.isPageSelected(p,v)?"elevated":"flat",onClick:y=>i.handlePageClick(p,v)},{default:a(()=>[r(b(v),1)]),_:2},1032,["color","variant","onClick"]))),128))])):_("",!0)]))),128)):_("",!0),(c=s.templateData.actions)!=null&&c.length?(f(),x("div",Nn,[(f(!0),x(z,null,O(s.templateData.actions,m=>(f(),C(q,{key:m,class:"ma-1",color:"primary",variant:"flat",onClick:p=>i.insertTemplate(m)},{default:a(()=>[r(b(m),1)]),_:2},1032,["onClick"]))),128))])):_("",!0)])):(f(),x("div",Rn," 暂无可用的模板 "))])):_("",!0)]),i.showQuickTools?(f(),x("div",En,[o("div",Bn,[o("div",Mn,[(f(),x(z,null,O(3,m=>n(k,{key:m,size:"small",variant:"tonal",class:"keypad-btn",onClick:p=>i.insertAtCursor(String(m))},{default:a(()=>[r(b(m),1)]),_:2},1032,["onClick"])),64))]),o("div",jn,[(f(),x(z,null,O(3,m=>n(k,{key:m,size:"small",variant:"tonal",class:"keypad-btn",onClick:p=>i.insertAtCursor(String(m+3))},{default:a(()=>[r(b(m+3),1)]),_:2},1032,["onClick"])),64))]),o("div",Un,[(f(),x(z,null,O(3,m=>n(k,{key:m,size:"small",variant:"tonal",class:"keypad-btn",onClick:p=>i.insertAtCursor(String(m+6))},{default:a(()=>[r(b(m+6),1)]),_:2},1032,["onClick"])),64))]),o("div",On,[n(k,{size:"small",variant:"tonal",class:"keypad-btn",onClick:e[1]||(e[1]=m=>i.insertAtCursor("-"))},{default:a(()=>[...e[6]||(e[6]=[r(" - ",-1)])]),_:1}),n(k,{size:"small",variant:"tonal",class:"keypad-btn",onClick:e[2]||(e[2]=m=>i.insertAtCursor("0"))},{default:a(()=>[...e[7]||(e[7]=[r(" 0 ",-1)])]),_:1}),n(k,{size:"small",variant:"tonal",class:"keypad-btn",color:"error",onClick:i.deleteLastChar},{default:a(()=>[...e[8]||(e[8]=[r(" ← ",-1)])]),_:1},8,["onClick"])]),o("div",$n,[n(k,{size:"small",variant:"tonal",class:"keypad-btn space-btn",onClick:e[3]||(e[3]=m=>i.insertAtCursor(" "))},{default:a(()=>[...e[9]||(e[9]=[r(" 空格 ",-1)])]),_:1}),n(k,{size:"small",variant:"tonal",class:"keypad-btn space-btn",onClick:e[4]||(e[4]=m=>i.insertAtCursor(`
`))},{default:a(()=>[...e[10]||(e[10]=[r(" 换行 ",-1)])]),_:1})])]),o("div",Kn,[(f(!0),x(z,null,O(s.quickTexts,m=>(f(),C(k,{key:m,size:"small",variant:"flat",onClick:p=>i.insertAtCursor(m)},{default:a(()=>[r(b(m),1)]),_:2},1032,["onClick"]))),128))])])):_("",!0)])]}),_:1}),e[11]||(e[11]=o("div",{class:"text-center text-body-2 text-disabled mb-5"}," 点击空白处完成编辑 ",-1))]),_:1})]),_:1},8,["modelValue","onClick:outside"])}const It=ue(_n,[["render",Hn],["__scopeId","data-v-42c6da75"]]),qn=Ne({autoSelectFirst:{type:[Boolean,String]},clearOnSelect:Boolean,search:String,...Os({filterKeys:["title"]}),...Us(),...ds(Is({modelValue:null,role:"combobox"}),["validationValue","dirty","appendInnerIcon"])},"VAutocomplete"),Gn=Fe()({name:"VAutocomplete",props:qn(),emits:{"update:focused":t=>!0,"update:search":t=>!0,"update:modelValue":t=>!0,"update:menu":t=>!0},setup(t,e){let{slots:l}=e;const{t:u}=es(),s=E(),i=ye(!1),c=ye(!0),m=ye(!1),p=E(),v=E(),y=ye(-1),D=ye(null),{items:d,transformIn:B,transformOut:Q}=ts(t),{textColorClasses:h,textColorStyles:N}=ss(()=>{var g;return(g=s.value)==null?void 0:g.color}),U=Ue(t,"search",""),V=Ue(t,"modelValue",[],g=>B(g===null?[null]:ns(g)),g=>{const I=Q(g);return t.multiple?I:I[0]??null}),w=K(()=>typeof t.counterValue=="function"?t.counterValue(V.value):typeof t.counterValue=="number"?t.counterValue:V.value.length),R=Ls(t),{filteredItems:he,getMatches:M}=Rs(t,d,()=>D.value??(c.value?"":U.value)),P=K(()=>t.hideSelected&&D.value===null?he.value.filter(g=>!V.value.some(I=>I.value===g.value)):he.value),te=K(()=>!!(t.chips||l.chip)),le=K(()=>te.value||!!l.selection),J=K(()=>V.value.map(g=>g.props.value)),ie=K(()=>{var I;return(t.autoSelectFirst===!0||t.autoSelectFirst==="exact"&&U.value===((I=P.value[0])==null?void 0:I.title))&&P.value.length>0&&!c.value&&!m.value}),pe=K(()=>t.hideNoData&&!P.value.length||R.isReadonly.value||R.isDisabled.value),Be=Ue(t,"menu"),W=K({get:()=>Be.value,set:g=>{var I;Be.value&&!g&&((I=p.value)!=null&&I.ΨopenChildren.size)||g&&pe.value||(Be.value=g)}}),{menuId:Ft,ariaExpanded:Nt,ariaControls:Rt,ariaLabel:Qe}=Es(t,W),Me=E(),Et=Bs(Me,s);function Bt(g){t.openOnClear&&(W.value=!0),U.value=""}function Mt(){pe.value||(W.value=!0)}function jt(g){pe.value||(i.value&&(g.preventDefault(),g.stopPropagation()),W.value=!W.value)}function Ut(g){var I;(lt(g)||g.key==="Backspace")&&((I=s.value)==null||I.focus())}function Ot(g){var A,H,Z,re,F;if(R.isReadonly.value)return;const I=(A=s.value)==null?void 0:A.selectionStart,j=V.value.length;if(["Enter","ArrowDown","ArrowUp"].includes(g.key)&&g.preventDefault(),["Enter","ArrowDown"].includes(g.key)&&(W.value=!0),["Escape"].includes(g.key)&&(W.value=!1),ie.value&&["Enter","Tab"].includes(g.key)&&!V.value.some($=>{let{value:G}=$;return G===P.value[0].value})&&ge(P.value[0]),g.key==="ArrowDown"&&ie.value&&((H=Me.value)==null||H.focus("next")),["Backspace","Delete"].includes(g.key)){if(!t.multiple&&le.value&&V.value.length>0&&!U.value)return ge(V.value[0],!1);if(~y.value){g.preventDefault();const $=y.value;ge(V.value[y.value],!1),y.value=$>=j-1?j-2:$}else g.key==="Backspace"&&!U.value&&(y.value=j-1);return}if(t.multiple)if(g.key==="ArrowLeft"){if(y.value<0&&I&&I>0)return;const $=y.value>-1?y.value-1:j-1;if(V.value[$])y.value=$;else{const G=((Z=U.value)==null?void 0:Z.length)??null;y.value=-1,(re=s.value)==null||re.setSelectionRange(G,G)}}else if(g.key==="ArrowRight"){if(y.value<0)return;const $=y.value+1;V.value[$]?y.value=$:(y.value=-1,(F=s.value)==null||F.setSelectionRange(0,0))}else~y.value&&lt(g)&&(y.value=-1)}function $t(g){if(it(s.value,":autofill")||it(s.value,":-webkit-autofill")){const I=d.value.find(j=>j.title===g.target.value);I&&ge(I)}}function Kt(){var g;t.eager&&((g=v.value)==null||g.calculateVisibleItems())}function Ht(){var g;i.value&&(c.value=!0,(g=s.value)==null||g.focus()),D.value=null}function qt(g){i.value=!0,setTimeout(()=>{m.value=!0})}function Gt(g){m.value=!1}function Yt(g){(g==null||g===""&&!t.multiple&&!le.value)&&(V.value=[])}const je=ye(!1);function ge(g){let I=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(!(!g||g.props.disabled))if(t.multiple){const j=V.value.findIndex(H=>(t.valueComparator||us)(H.value,g.value)),A=I??!~j;if(~j){const H=A?[...V.value,g]:[...V.value];H.splice(j,1),V.value=H}else A&&(V.value=[...V.value,g]);t.clearOnSelect&&(U.value="")}else{const j=I!==!1;V.value=j?[g]:[],D.value=c.value?"":U.value??"",U.value=j&&!le.value?g.title:"",at(()=>{W.value=!1,c.value=!0})}}return be(i,(g,I)=>{var j;g!==I&&(g?(je.value=!0,U.value=t.multiple||le.value?"":String(((j=V.value.at(-1))==null?void 0:j.props.title)??""),c.value=!0,at(()=>je.value=!1)):(!t.multiple&&U.value==null&&(V.value=[]),W.value=!1,!c.value&&U.value&&(D.value=U.value),U.value="",y.value=-1))}),be(U,g=>{!i.value||je.value||(g&&(W.value=!0),c.value=!g)}),be(W,g=>{if(!t.hideSelected&&g&&V.value.length&&c.value){const I=P.value.findIndex(j=>V.value.some(A=>j.value===A.value));as&&window.requestAnimationFrame(()=>{var j;I>=0&&((j=v.value)==null||j.scrollToIndex(I))})}g&&(D.value=null)}),be(d,(g,I)=>{W.value||i.value&&!I.length&&g.length&&(W.value=!0)}),Re(()=>{const g=!!(!t.hideNoData||P.value.length||l["prepend-item"]||l["append-item"]||l["no-data"]),I=V.value.length>0,j=ve.filterProps(t);return n(ve,oe({ref:s},j,{modelValue:U.value,"onUpdate:modelValue":[A=>U.value=A,Yt],focused:i.value,"onUpdate:focused":A=>i.value=A,validationValue:V.externalValue,counterValue:w.value,dirty:I,onChange:$t,class:["v-autocomplete",`v-autocomplete--${t.multiple?"multiple":"single"}`,{"v-autocomplete--active-menu":W.value,"v-autocomplete--chips":!!t.chips,"v-autocomplete--selection-slot":!!le.value,"v-autocomplete--selecting-index":y.value>-1},t.class],style:t.style,readonly:R.isReadonly.value,placeholder:I?void 0:t.placeholder,"onClick:clear":Bt,"onMousedown:control":Mt,onKeydown:Ot,"aria-expanded":Nt.value,"aria-controls":Rt.value}),{...l,default:()=>o(z,null,[n(Ct,oe({id:Ft.value,ref:p,modelValue:W.value,"onUpdate:modelValue":A=>W.value=A,activator:"parent",contentClass:"v-autocomplete__content",disabled:pe.value,eager:t.eager,maxHeight:310,openOnClick:!1,closeOnContentClick:!1,onAfterEnter:Kt,onAfterLeave:Ht},t.menuProps),{default:()=>[g&&n(Ke,oe({ref:Me,filterable:!0,selected:J.value,selectStrategy:t.multiple?"independent":"single-independent",onMousedown:A=>A.preventDefault(),onKeydown:Ut,onFocusin:qt,onFocusout:Gt,tabindex:"-1",selectable:!0,"aria-live":"polite",color:t.itemColor??t.color},Et,t.listProps),{default:()=>{var A,H,Z;return[(A=l["prepend-item"])==null?void 0:A.call(l),!P.value.length&&!t.hideNoData&&(((H=l["no-data"])==null?void 0:H.call(l))??n(Ae,{key:"no-data",title:u(t.noDataText)},null)),n(Ms,{ref:v,renderless:!0,items:P.value,itemKey:"value"},{default:re=>{var Ze,et,tt;let{item:F,index:$,itemRef:G}=re;const Xe=oe(F.props,{ref:G,key:F.value,active:ie.value&&$===0?!0:void 0,onClick:()=>ge(F,null)});return F.type==="divider"?((Ze=l.divider)==null?void 0:Ze.call(l,{props:F.raw,index:$}))??n(Se,oe(F.props,{key:`divider-${$}`}),null):F.type==="subheader"?((et=l.subheader)==null?void 0:et.call(l,{props:F.raw,index:$}))??n(is,oe(F.props,{key:`subheader-${$}`}),null):((tt=l.item)==null?void 0:tt.call(l,{item:F,index:$,props:Xe}))??n(Ae,oe(Xe,{role:"option"}),{prepend:_e=>{let{isSelected:Wt}=_e;return o(z,null,[t.multiple&&!t.hideSelected?n($s,{key:F.value,modelValue:Wt,ripple:!1,tabindex:"-1",onClick:Jt=>Jt.preventDefault()},null):void 0,F.props.prependAvatar&&n(Ge,{image:F.props.prependAvatar},null),F.props.prependIcon&&n(T,{icon:F.props.prependIcon},null)])},title:()=>{var _e;return c.value?F.title:js("v-autocomplete",F.title,(_e=M(F))==null?void 0:_e.title)}})}}),(Z=l["append-item"])==null?void 0:Z.call(l)]}})]}),V.value.map((A,H)=>{function Z(G){G.stopPropagation(),G.preventDefault(),ge(A,!1)}const re={"onClick:close":Z,onKeydown(G){G.key!=="Enter"&&G.key!==" "||(G.preventDefault(),G.stopPropagation(),Z(G))},onMousedown(G){G.preventDefault(),G.stopPropagation()},modelValue:!0,"onUpdate:modelValue":void 0},F=te.value?!!l.chip:!!l.selection,$=F?os(te.value?l.chip({item:A,index:H,props:re}):l.selection({item:A,index:H})):void 0;if(!(F&&!$))return o("div",{key:A.value,class:ae(["v-autocomplete__selection",H===y.value&&["v-autocomplete__selection--selected",h.value]]),style:X(H===y.value?N.value:{})},[te.value?l.chip?n(vt,{key:"chip-defaults",defaults:{VChip:{closable:t.closableChips,size:"small",text:A.title}}},{default:()=>[$]}):n(q,oe({key:"chip",closable:t.closableChips,size:"small",text:A.title,disabled:A.props.disabled},re),null):$??o("span",{class:"v-autocomplete__selection-text"},[A.title,t.multiple&&H<V.value.length-1&&o("span",{class:"v-autocomplete__selection-comma"},[r(",")])])])})]),"append-inner":function(){var re,F;for(var A=arguments.length,H=new Array(A),Z=0;Z<A;Z++)H[Z]=arguments[Z];return o(z,null,[(re=l["append-inner"])==null?void 0:re.call(l,...H),t.menuIcon?n(T,{class:"v-autocomplete__menu-icon",color:(F=s.value)==null?void 0:F.fieldIconColor,icon:t.menuIcon,onMousedown:jt,onClick:ls,"aria-label":Qe.value,title:Qe.value,tabindex:"-1"},null):void 0])}})}),rs({isFocused:i,isPristine:c,menu:W,search:U,filteredItems:he,select:ge},s)}}),Yn={key:0,class:"mt-2 text-caption text-medium-emphasis"},Wn={__name:"StudentNameManager",emits:["token-info-updated"],setup(t,{expose:e,emit:l}){const u=l,s=E(!1),i=E(""),c=E([]),m=E(""),p=E(!1),v=E(""),y=E(null),D=K(()=>{var M;return((M=y.value)==null?void 0:M.deviceType)==="student"}),d=K(()=>{var M;return((M=y.value)==null?void 0:M.isReadOnly)===!0}),B=K(()=>{var M;return((M=y.value)==null?void 0:M.note)||"设置名称"}),Q=K(()=>!!h.value),h=K(()=>S("server.kvToken")),N=K(()=>S("server.provider")),U=K(()=>N.value==="kv-server"||N.value==="classworkscloud"),V=async()=>{if(!(!U.value||!h.value))try{const M=S("server.domain");if(!M)return;const P=await Te.get(`${M}/kv/_token`,{headers:{Authorization:`Bearer ${h.value}`}});if(y.value=P.data,y.value.deviceType!=="student")return;m.value=y.value.note||"";const le=(await Te.get(`${M}/kv/classworks-list-main`,{headers:{Authorization:`Bearer ${h.value}`}})).data.value||[];if(c.value=Array.isArray(le)?le:[],c.value.length===0)return;const J=y.value.note||"",ie=c.value.some(pe=>pe.name===J);(!J||!ie)&&(s.value=!0,i.value="")}catch(M){console.error("检查学生姓名状态失败:",M)}},w=async()=>{var M,P,te,le;if(!(!i.value||p.value)){v.value="",p.value=!0;try{const J=S("server.domain"),ie=h.value;(await Te.post(`${J}/apps/tokens/${ie}/set-student-name`,{name:i.value})).data.success&&(m.value=i.value,s.value=!1,await V(),u("token-info-updated"))}catch(J){const ie=(M=J==null?void 0:J.response)==null?void 0:M.status;ie===400?v.value="该名称不在学生列表中，请选择正确的姓名":ie===403?v.value="只有学生类型的 Token 可以设置姓名":ie===404?v.value="设备未设置学生列表或 Token 不存在":v.value=((le=(te=(P=J==null?void 0:J.response)==null?void 0:P.data)==null?void 0:te.error)==null?void 0:le.message)||(J==null?void 0:J.message)||"设置失败，请稍后重试"}finally{p.value=!1}}},R=()=>{s.value=!1},he=async()=>{if(console.log("StudentNameManager.openDialog called"),console.log("isStudentToken:",D.value),console.log("studentList.length:",c.value.length),console.log("currentStudentName:",m.value),!D.value){console.log("Not a student token, cannot open dialog");return}c.value=await Ce.loadData("classworks-list-main"),c.value.length===0?(console.log("Student list is empty, trying to load..."),V().then(()=>{c.value.length>0?(i.value=m.value,s.value=!0):console.warn("Student list is still empty after reload")})):(i.value=m.value,s.value=!0,console.log("Dialog opened, showDialog:",s.value))};return be(h,()=>{V()}),pt(()=>{V()}),be(y,()=>{u("token-info-updated")},{deep:!0}),gt(()=>{V()}),e({checkStudentNameStatus:V,openDialog:he,currentStudentName:m,isStudentToken:D,isReadOnly:d,displayName:B,hasToken:Q,tokenInfo:y}),(M,P)=>(f(),x(z,null,[n(de,{modelValue:s.value,"onUpdate:modelValue":P[1]||(P[1]=te=>s.value=te),"max-width":"500",persistent:""},{default:a(()=>[n(L,null,{default:a(()=>[n(se,null,{default:a(()=>[...P[2]||(P[2]=[r("设置学生姓名",-1)])]),_:1}),n(Y,null,{default:a(()=>[P[3]||(P[3]=o("div",{class:"mb-2"}," 请从列表中选择您的姓名： ",-1)),n(Gn,{modelValue:i.value,"onUpdate:modelValue":P[0]||(P[0]=te=>i.value=te),items:c.value,"item-title":"name","item-value":"name",label:"学生姓名",placeholder:"选择您的姓名",clearable:"","hide-details":""},null,8,["modelValue","items"]),c.value.length>0?(f(),x("div",Yn," 共 "+b(c.value.length)+" 位学生 ",1)):_("",!0),v.value?(f(),C(Ee,{key:1,type:"error",variant:"tonal",class:"mt-3"},{default:a(()=>[r(b(v.value),1)]),_:1})):_("",!0)]),_:1}),n(fe,null,{default:a(()=>[n(k,{variant:"text",onClick:R},{default:a(()=>[...P[4]||(P[4]=[r(" 稍后设置 ",-1)])]),_:1}),n(ne),n(k,{disabled:!i.value||p.value,loading:p.value,color:"primary",onClick:w},{default:a(()=>[...P[5]||(P[5]=[r(" 确认 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),cs(M.$slots,"header-display",{studentName:m.value,isStudent:D.value,openDialog:he},void 0)],64))}},zt=ue(Wn,[["__scopeId","data-v-2a2a597b"]]),Jn={class:"text-center mb-6"},Qn={class:"text-body-2"},Xn={class:"form-section"},Zn={__name:"DeviceAuthDialog",props:{showCancel:{type:Boolean,default:!1}},emits:["success","cancel"],setup(t,{expose:e,emit:l}){const u=l,s=E({namespace:"",password:""}),i=E(!1),c=E(""),m=async()=>{var p,v,y,D,d;if(!(!s.value.namespace||i.value)){c.value="",i.value=!0;try{const B=S("server.domain");if(!B)throw new Error("未配置服务器域名");const Q=await Te.post(`${B}/apps/auth/token`,{namespace:s.value.namespace,password:s.value.password||void 0,appId:"d158067f53627d2b98babe8bffd2fd7d"});if(!Q.data.success)throw new Error("设备验证失败");const h=Q.data;me("server.kvToken",h.token),(p=h.device)!=null&&p.uuid&&me("device.uuid",h.device.uuid),u("success",h)}catch(B){const Q=(v=B==null?void 0:B.response)==null?void 0:v.status;Q===401||Q===403?c.value="密码错误或无权限访问":Q===404?c.value="设备不存在,请检查 namespace 是否正确":c.value=((d=(D=(y=B==null?void 0:B.response)==null?void 0:y.data)==null?void 0:D.error)==null?void 0:d.message)||(B==null?void 0:B.message)||"认证失败,请稍后重试"}finally{i.value=!1}}};return e({reset:()=>{s.value={namespace:"",password:""},c.value=""}}),(p,v)=>(f(),C(L,{class:"auth-card"},{default:a(()=>[n(Y,{class:"pa-8"},{default:a(()=>[o("div",Jn,[n(T,{size:"80",color:"success",class:"mb-4"},{default:a(()=>[...v[4]||(v[4]=[r(" mdi-account-key ",-1)])]),_:1}),v[5]||(v[5]=o("h2",{class:"text-h4 mb-3"}," 设备认证 ",-1)),v[6]||(v[6]=o("p",{class:"text-body-1 text-medium-emphasis"}," 输入你在 Classworks KV 获取的认证信息 ",-1))]),n(L,{variant:"tonal",color:"info",class:"pa-4 mb-6"},{default:a(()=>[o("div",Qn,[n(T,{size:"20",class:"mr-2"},{default:a(()=>[...v[7]||(v[7]=[r(" mdi-information ",-1)])]),_:1}),v[8]||(v[8]=r(" 对于已有UUID的用户，您应当使用UUID与您的密码登录。 ",-1))])]),_:1}),o("div",Xn,[n(ve,{modelValue:s.value.namespace,"onUpdate:modelValue":v[0]||(v[0]=y=>s.value.namespace=y),label:"命名空间",class:"mb-4",variant:"outlined","hide-details":"auto","prepend-inner-icon":"mdi-identifier"},null,8,["modelValue"]),n(ve,{modelValue:s.value.password,"onUpdate:modelValue":v[1]||(v[1]=y=>s.value.password=y),label:"认证码",type:"text",variant:"outlined","prepend-inner-icon":"mdi-lock-outline"},null,8,["modelValue"]),c.value?(f(),C(Ee,{key:0,type:"error",variant:"tonal",class:"mt-4",closable:"","onClick:close":v[2]||(v[2]=y=>c.value="")},{default:a(()=>[r(b(c.value),1)]),_:1})):_("",!0)])]),_:1}),n(fe,{class:"pa-6 pt-0"},{default:a(()=>[t.showCancel?(f(),C(k,{key:0,size:"large",variant:"text",onClick:v[3]||(v[3]=y=>p.$emit("cancel"))},{default:a(()=>[...v[9]||(v[9]=[r(" 取消 ",-1)])]),_:1})):_("",!0),n(ne),n(k,{disabled:!s.value.namespace||i.value,loading:i.value,size:"x-large",color:"primary",variant:"elevated",class:"px-8",onClick:m},{default:a(()=>[n(T,{start:"",size:"24"},{default:a(()=>[...v[10]||(v[10]=[r(" mdi-login ",-1)])]),_:1}),v[11]||(v[11]=o("span",{class:"text-h6"},"认证并登录",-1))]),_:1},8,["disabled","loading"])]),_:1})]),_:1}))}},ea=ue(Zn,[["__scopeId","data-v-4586c8bf"]]),ta={__name:"TokenInputDialog",props:{showCancel:{type:Boolean,default:!1}},emits:["success","cancel"],setup(t,{expose:e,emit:l}){const u=l,s=E(""),i=E(!1),c=E(""),m=async()=>{var p,v,y;if(!(!s.value||i.value)){c.value="",i.value=!0;try{const D=S("server.domain");if(!D)throw new Error("未配置服务器域名");await Te.get(`${D}/kv/_info`,{headers:{Accept:"application/json","x-app-token":s.value}}),me("server.kvToken",s.value),u("success")}catch(D){const d=(p=D==null?void 0:D.response)==null?void 0:p.status;d===401||d===403?c.value="Token 无效或无权限,请确认后重试":d===404?c.value="命名空间不存在或服务器未就绪":c.value=((y=(v=D==null?void 0:D.response)==null?void 0:v.data)==null?void 0:y.message)||(D==null?void 0:D.message)||"验证失败,请稍后重试"}finally{i.value=!1}}};return e({reset:()=>{s.value="",c.value=""}}),(p,v)=>(f(),C(L,null,{default:a(()=>[n(se,null,{default:a(()=>[...v[2]||(v[2]=[r("输入授权 Token",-1)])]),_:1}),n(Y,null,{default:a(()=>[n(ve,{modelValue:s.value,"onUpdate:modelValue":v[0]||(v[0]=y=>s.value=y),label:"KV 授权 Token",placeholder:"粘贴从授权页面获取的 Token",variant:"outlined",density:"comfortable","hide-details":"auto",clearable:""},null,8,["modelValue"]),c.value?(f(),C(Ee,{key:0,type:"error",variant:"tonal",class:"mt-3"},{default:a(()=>[r(b(c.value),1)]),_:1})):_("",!0)]),_:1}),n(fe,null,{default:a(()=>[n(ne),t.showCancel?(f(),C(k,{key:0,variant:"text",onClick:v[1]||(v[1]=y=>p.$emit("cancel"))},{default:a(()=>[...v[3]||(v[3]=[r(" 取消 ",-1)])]),_:1})):_("",!0),n(k,{disabled:!s.value||i.value,loading:i.value,color:"primary",onClick:m},{default:a(()=>[...v[4]||(v[4]=[r(" 保存 Token ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1}))}},sa={__name:"AlternativeCodeDialog",props:{showCancel:{type:Boolean,default:!1}},emits:["submit","cancel"],setup(t,{expose:e,emit:l}){const u=l,s=E(""),i=()=>{s.value&&u("submit",s.value)};return e({reset:()=>{s.value=""}}),(c,m)=>(f(),C(L,null,{default:a(()=>[n(se,null,{default:a(()=>[...m[2]||(m[2]=[r("输入替代代码",-1)])]),_:1}),n(Y,null,{default:a(()=>[n(Je,{modelValue:s.value,"onUpdate:modelValue":m[0]||(m[0]=p=>s.value=p),label:"替代代码",placeholder:"请输入替代代码",variant:"outlined",density:"comfortable",rows:"5","hide-details":"auto"},null,8,["modelValue"]),n(Ee,{type:"info",variant:"tonal",class:"mt-3"},{default:a(()=>[...m[3]||(m[3]=[r(" 替代代码功能暂未实现，敬请期待 ",-1)])]),_:1})]),_:1}),n(fe,null,{default:a(()=>[n(ne),t.showCancel?(f(),C(k,{key:0,variant:"text",onClick:m[1]||(m[1]=p=>c.$emit("cancel"))},{default:a(()=>[...m[4]||(m[4]=[r(" 取消 ",-1)])]),_:1})):_("",!0),n(k,{disabled:!s.value,color:"primary",onClick:i},{default:a(()=>[...m[5]||(m[5]=[r(" 提交 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1}))}},na=Ne({dotColor:String,fillDot:Boolean,hideDot:Boolean,icon:xt,iconColor:String,lineColor:String,...Ye(),...bt(),...yt(),...kt()},"VTimelineDivider"),aa=Fe()({name:"VTimelineDivider",props:na(),setup(t,e){let{slots:l}=e;const{sizeClasses:u,sizeStyles:s}=ms(t,"v-timeline-divider__dot"),{backgroundColorStyles:i,backgroundColorClasses:c}=ot(()=>t.dotColor),{roundedClasses:m}=fs(t,"v-timeline-divider__dot"),{elevationClasses:p}=hs(t),{backgroundColorClasses:v,backgroundColorStyles:y}=ot(()=>t.lineColor);return Re(()=>o("div",{class:ae(["v-timeline-divider",{"v-timeline-divider--fill-dot":t.fillDot},t.class]),style:X(t.style)},[o("div",{class:ae(["v-timeline-divider__before",v.value]),style:X(y.value)},null),!t.hideDot&&o("div",{key:"dot",class:ae(["v-timeline-divider__dot",p.value,m.value,u.value]),style:X(s.value)},[o("div",{class:ae(["v-timeline-divider__inner-dot",c.value,m.value]),style:X(i.value)},[l.default?n(vt,{key:"icon-defaults",disabled:!t.icon,defaults:{VIcon:{color:t.iconColor,icon:t.icon,size:t.size}}},l.default):n(T,{key:"icon",color:t.iconColor,icon:t.icon,size:t.size},null)])]),o("div",{class:ae(["v-timeline-divider__after",v.value]),style:X(y.value)},null)])),{}}}),Pt=Ne({density:String,dotColor:String,fillDot:Boolean,hideDot:Boolean,hideOpposite:{type:Boolean,default:void 0},icon:xt,iconColor:String,lineInset:[Number,String],side:{type:String,validator:t=>t==null||["start","end"].includes(t)},...Ye(),...ps(),...kt(),...bt(),...yt(),...wt()},"VTimelineItem"),Le=Fe()({name:"VTimelineItem",props:Pt(),setup(t,e){let{slots:l}=e;const{dimensionStyles:u}=vs(t),s=ye(0),i=E();return be(i,c=>{var m;c&&(s.value=((m=c.$el.querySelector(".v-timeline-divider__dot"))==null?void 0:m.getBoundingClientRect().width)??0)},{flush:"post"}),Re(()=>{var c,m;return o("div",{class:ae(["v-timeline-item",{"v-timeline-item--fill-dot":t.fillDot,"v-timeline-item--side-start":t.side==="start","v-timeline-item--side-end":t.side==="end"},t.class]),style:X([{"--v-timeline-dot-size":ze(s.value),"--v-timeline-line-inset":t.lineInset?`calc(var(--v-timeline-dot-size) / 2 + ${ze(t.lineInset)})`:ze(0)},t.style])},[o("div",{class:"v-timeline-item__body",style:X(u.value)},[(c=l.default)==null?void 0:c.call(l)]),n(aa,{ref:i,hideDot:t.hideDot,icon:t.icon,iconColor:t.iconColor,size:t.size,elevation:t.elevation,dotColor:t.dotColor,fillDot:t.fillDot,rounded:t.rounded},{default:l.icon}),t.density!=="compact"&&o("div",{class:"v-timeline-item__opposite"},[!t.hideOpposite&&((m=l.opposite)==null?void 0:m.call(l))])])}),{}}}),la=Ne({align:{type:String,default:"center",validator:t=>["center","start"].includes(t)},direction:{type:String,default:"vertical",validator:t=>["vertical","horizontal"].includes(t)},justify:{type:String,default:"auto",validator:t=>["auto","center"].includes(t)},side:{type:String,validator:t=>t==null||["start","end"].includes(t)},lineThickness:{type:[String,Number],default:2},lineColor:String,truncateLine:{type:String,validator:t=>["start","end","both"].includes(t)},...Ss(Pt({lineInset:0}),["dotColor","fillDot","hideOpposite","iconColor","lineInset","size"]),...Ye(),...ws(),...wt(),...xs()},"VTimeline"),ia=Fe()({name:"VTimeline",props:la(),setup(t,e){let{slots:l}=e;const{themeClasses:u}=gs(t),{densityClasses:s}=ks(t),{rtlClasses:i}=ys();bs({VTimelineDivider:{lineColor:ce(()=>t.lineColor)},VTimelineItem:{density:ce(()=>t.density),dotColor:ce(()=>t.dotColor),fillDot:ce(()=>t.fillDot),hideOpposite:ce(()=>t.hideOpposite),iconColor:ce(()=>t.iconColor),lineColor:ce(()=>t.lineColor),lineInset:ce(()=>t.lineInset),size:ce(()=>t.size)}});const c=K(()=>{const p=t.side?t.side:t.density!=="default"?"end":null;return p&&`v-timeline--side-${p}`}),m=K(()=>{const p=["v-timeline--truncate-line-start","v-timeline--truncate-line-end"];switch(t.truncateLine){case"both":return p;case"start":return p[0];case"end":return p[1];default:return null}});return Re(()=>n(t.tag,{class:ae(["v-timeline",`v-timeline--${t.direction}`,`v-timeline--align-${t.align}`,`v-timeline--justify-${t.justify}`,m.value,{"v-timeline--inset-line":!!t.lineInset},u.value,s.value,c.value,i.value,t.class]),style:X([{"--v-timeline-line-thickness":ze(t.lineThickness)},t.style])},l)),{}}}),oa={class:"step-content"},ra={class:"text-center mb-6"},da={class:"step-content"},ua={class:"relationship-diagram"},ca={class:"diagram-item"},ma={class:"text-center"},fa={class:"diagram-description mt-3"},ha={class:"diagram-connector"},va={class:"diagram-item"},pa={class:"text-center"},ga={class:"diagram-description mt-3"},ka={class:"text-h6 mb-4"},ya={class:"step-content"},ba={class:"button-group"},xa={class:"d-flex flex-column align-center py-2"},wa={class:"d-flex flex-column align-center py-2"},Sa={class:"step-content"},Ca={class:"text-center mb-6"},Da={class:"step-content"},Va={class:"text-center mb-6"},Ta={class:"text-h6 font-weight-bold"},_a={class:"text-h5 mb-6"},La={class:"text-subtitle-2"},Ia={class:"text-body-1 mb-3"},za={class:"d-flex align-center"},Pa={class:"d-flex align-center"},ft=4,Aa={__name:"FirstTimeGuide",emits:["close"],setup(t,{emit:e}){const l=e,u=S("server.authDomain"),s=E(1),i=E(""),c=()=>{s.value<ft&&s.value++},m=()=>{s.value>1&&s.value--},p=D=>{i.value=D,c()},v=()=>{l("close")},y=()=>{window.open(u,"_blank")};return(D,d)=>(f(),C(L,{class:"guide-card"},{default:a(()=>[n(Cs,{"model-value":s.value/ft*100,color:"primary",height:"6"},null,8,["model-value"]),n(Y,{class:"pa-8"},{default:a(()=>[ee(o("div",oa,[o("div",ra,[n(T,{size:"80",color:"primary",class:"mb-4"},{default:a(()=>[...d[2]||(d[2]=[r(" mdi-hand-wave ",-1)])]),_:1}),d[3]||(d[3]=o("h2",{class:"text-h4 mb-3"}," 欢迎使用 Classworks ",-1)),d[4]||(d[4]=o("p",{class:"text-body-1 text-medium-emphasis"}," 适用于班级大屏的作业板小工具 ",-1))])],512),[[we,s.value===1]]),ee(o("div",da,[d[32]||(d[32]=o("h3",{class:"text-h5 mb-6 text-center"}," Classworks 和 Classworks KV 的关系 ",-1)),n(L,{variant:"tonal",color:"primary",class:"pa-6 mb-6"},{default:a(()=>[o("div",ua,[o("div",ca,[n(L,{elevation:"8",color:"blue-darken-1",class:"pa-4"},{default:a(()=>[o("div",ma,[n(T,{size:"60",color:"white"},{default:a(()=>[...d[5]||(d[5]=[r(" mdi-laptop ",-1)])]),_:1}),d[6]||(d[6]=o("h4",{class:"text-h6 text-white mt-2"}," Classworks ",-1)),d[7]||(d[7]=o("p",{class:"text-caption text-white mt-1"}," 作业板应用 ",-1))])]),_:1}),o("div",fa,[n(q,{color:"blue",variant:"flat",size:"small",class:"mb-2"},{default:a(()=>[...d[8]||(d[8]=[r(" 前端应用 ",-1)])]),_:1}),d[9]||(d[9]=o("div",{class:"text-body-2"},[r(" • 显示作业内容"),o("br"),r(" • 管理班级信息"),o("br"),r(" • 提供用户界面 ")],-1))])]),o("div",ha,[n(T,{size:"40",color:"primary"},{default:a(()=>[...d[10]||(d[10]=[r(" mdi-swap-horizontal ",-1)])]),_:1}),d[11]||(d[11]=o("div",{class:"text-caption font-weight-bold mt-2"}," 数据同步 ",-1))]),o("div",va,[n(L,{elevation:"8",color:"green-darken-1",class:"pa-4"},{default:a(()=>[o("div",pa,[n(T,{size:"60",color:"white"},{default:a(()=>[...d[12]||(d[12]=[r(" mdi-cloud-sync ",-1)])]),_:1}),d[13]||(d[13]=o("h4",{class:"text-h6 text-white mt-2"}," Classworks KV ",-1)),d[14]||(d[14]=o("p",{class:"text-caption text-white mt-1"}," 云端数据库 ",-1))])]),_:1}),o("div",ga,[n(q,{color:"green",variant:"flat",size:"small",class:"mb-2"},{default:a(()=>[...d[15]||(d[15]=[r(" 后端服务 ",-1)])]),_:1}),d[16]||(d[16]=o("div",{class:"text-body-2"},[r(" • 存储作业数据"),o("br"),r(" • 多设备同步"),o("br"),r(" • 权限管理 ")],-1))])])])]),_:1}),n(L,{variant:"outlined",class:"pa-5 mb-4"},{default:a(()=>[o("h4",ka,[n(T,{color:"primary",class:"mr-2"},{default:a(()=>[...d[17]||(d[17]=[r(" mdi-information ",-1)])]),_:1}),d[18]||(d[18]=r(" 工作流程 ",-1))]),n(ia,{side:"end",density:"compact","line-thickness":"2"},{default:a(()=>[n(Le,{"dot-color":"primary",size:"small"},{default:a(()=>[...d[19]||(d[19]=[o("div",{class:"text-body-2"},[o("strong",null,"步骤 1:"),r(" 在 Classworks 应用中编辑作业 ")],-1)])]),_:1}),n(Le,{"dot-color":"success",size:"small"},{default:a(()=>[...d[20]||(d[20]=[o("div",{class:"text-body-2"},[o("strong",null,"步骤 2:"),r(" 数据自动上传到 Classworks KV ")],-1)])]),_:1}),n(Le,{"dot-color":"info",size:"small"},{default:a(()=>[...d[21]||(d[21]=[o("div",{class:"text-body-2"},[o("strong",null,"步骤 3:"),r(" 其他设备从 Classworks KV 同步数据 ")],-1)])]),_:1}),n(Le,{"dot-color":"warning",size:"small"},{default:a(()=>[...d[22]||(d[22]=[o("div",{class:"text-body-2"},[o("strong",null,"步骤 4:"),r(" 所有设备显示相同的作业内容 ")],-1)])]),_:1})]),_:1})]),_:1}),n(Pe,null,{default:a(()=>[n(xe,{cols:"12",md:"4"},{default:a(()=>[n(L,{variant:"tonal",color:"blue",class:"pa-4 h-100"},{default:a(()=>[n(T,{size:"40",color:"blue-darken-2",class:"mb-2"},{default:a(()=>[...d[23]||(d[23]=[r(" mdi-devices ",-1)])]),_:1}),d[24]||(d[24]=o("h5",{class:"text-subtitle-1 font-weight-bold mb-2"}," 多设备访问 ",-1)),d[25]||(d[25]=o("p",{class:"text-body-2"}," 在教室、办公室、家中的任何设备上访问相同的数据 ",-1))]),_:1})]),_:1}),n(xe,{cols:"12",md:"4"},{default:a(()=>[n(L,{variant:"tonal",color:"green",class:"pa-4 h-100"},{default:a(()=>[n(T,{size:"40",color:"green-darken-2",class:"mb-2"},{default:a(()=>[...d[26]||(d[26]=[r(" mdi-sync ",-1)])]),_:1}),d[27]||(d[27]=o("h5",{class:"text-subtitle-1 font-weight-bold mb-2"}," 实时同步 ",-1)),d[28]||(d[28]=o("p",{class:"text-body-2"}," 修改后立即同步，所有设备保持数据一致 ",-1))]),_:1})]),_:1}),n(xe,{cols:"12",md:"4"},{default:a(()=>[n(L,{variant:"tonal",color:"orange",class:"pa-4 h-100"},{default:a(()=>[n(T,{size:"40",color:"orange-darken-2",class:"mb-2"},{default:a(()=>[...d[29]||(d[29]=[r(" mdi-shield-lock ",-1)])]),_:1}),d[30]||(d[30]=o("h5",{class:"text-subtitle-1 font-weight-bold mb-2"}," 安全可靠 ",-1)),d[31]||(d[31]=o("p",{class:"text-body-2"}," 通过密码和命名空间隔离，保护班级数据安全 ",-1))]),_:1})]),_:1})]),_:1})],512),[[we,s.value===2]]),ee(o("div",ya,[d[40]||(d[40]=o("h3",{class:"text-h5 mb-6 text-center"}," 你需要在多个设备上查看作业吗？ ",-1)),n(L,{variant:"tonal",color:"info",class:"mb-6 pa-4"},{default:a(()=>[...d[33]||(d[33]=[o("div",{class:"text-body-2"}," 比如：在家里电脑、手机上查看，或者多个教室设备共享数据 ",-1)])]),_:1}),o("div",ba,[n(k,{size:"x-large",block:"",variant:"elevated",color:"primary",class:"mb-4 py-6",onClick:d[0]||(d[0]=B=>p("cloud"))},{default:a(()=>[o("div",xa,[n(T,{size:"40",class:"mb-2"},{default:a(()=>[...d[34]||(d[34]=[r(" mdi-cloud-check ",-1)])]),_:1}),d[35]||(d[35]=o("span",{class:"text-h6"},"需要，使用云同步",-1)),d[36]||(d[36]=o("span",{class:"text-caption mt-1"},"多设备访问",-1))])]),_:1}),n(k,{size:"x-large",block:"",variant:"outlined",class:"py-6",onClick:d[1]||(d[1]=B=>p("local"))},{default:a(()=>[o("div",wa,[n(T,{size:"40",class:"mb-2"},{default:a(()=>[...d[37]||(d[37]=[r(" mdi-laptop ",-1)])]),_:1}),d[38]||(d[38]=o("span",{class:"text-h6"},"不需要，只用这台设备",-1)),d[39]||(d[39]=o("span",{class:"text-caption mt-1"},"本地存储",-1))])]),_:1})])],512),[[we,s.value===3]]),ee(o("div",Sa,[o("div",Ca,[n(T,{size:"80",color:"success",class:"mb-4"},{default:a(()=>[...d[41]||(d[41]=[r(" mdi-check-circle ",-1)])]),_:1}),d[43]||(d[43]=o("h3",{class:"text-h5 mb-4"}," 您可以使用本地模式 ",-1)),n(L,{variant:"tonal",class:"pa-4 text-left"},{default:a(()=>[...d[42]||(d[42]=[o("div",{class:"text-body-1 mb-2"}," 此数据将存储在您的浏览器中，如果您的浏览器不支持IndexedDB，可能会出现问题。如果您经常清除浏览器数据，请谨慎使用本地模式。 ",-1),o("div",{class:"text-body-1 mb-2"}," 在刚才地方点击使用本地模式的按钮使用。 ",-1)])]),_:1})])],512),[[we,s.value===4&&i.value==="local"]]),ee(o("div",Da,[o("div",Va,[n(T,{size:"80",color:"primary",class:"mb-4"},{default:a(()=>[...d[44]||(d[44]=[r(" mdi-cloud-cog ",-1)])]),_:1}),d[45]||(d[45]=o("h3",{class:"text-h5 mb-4"}," 需要先设置云端账号 ",-1))]),n(L,{variant:De(u)=="https://kv.houlang.cloud"?"elevated":"outlined",color:De(u)=="https://kv.houlang.cloud"?"primary":"error",class:"pa-6 mb-6",onClick:y},{default:a(()=>[n(T,{size:"48",class:"mb-3"},{default:a(()=>[...d[46]||(d[46]=[r(" mdi-open-in-new ",-1)])]),_:1}),o("h4",Ta," 请访问 "+b(De(u)=="https://kv.houlang.cloud"?"Classworks KV":"自定义的 Classworks KV 实例 ")+" 控制台 ",1),o("div",_a,b(De(u)),1),o("h6",La,b(De(u)=="https://kv.houlang.cloud"?"此实例由 Classworks KV 官方提供":"此链接由您的实例、预配代码或管理员管理，当前可能不是 Classworks KV 官方的实例地址。"),1)]),_:1},8,["variant","color"]),n(L,{variant:"tonal",color:"info",class:"pa-5"},{default:a(()=>[o("div",Ia,[n(T,{size:"20",class:"mr-2"},{default:a(()=>[...d[47]||(d[47]=[r(" mdi-information ",-1)])]),_:1}),d[48]||(d[48]=r(" 在控制台完成以下操作： ",-1))]),d[49]||(d[49]=o("div",{class:"text-body-2 mb-2"}," 1. 注册或登录账号 ",-1)),d[50]||(d[50]=o("div",{class:"text-body-2 mb-2"}," 2. 创建班级空间 ",-1)),d[51]||(d[51]=o("div",{class:"text-body-2 mb-2"}," 3. 获取命名空间和密码 ",-1)),d[52]||(d[52]=o("div",{class:"text-body-2"}," 4. 返回这里输入认证信息 ",-1))]),_:1}),n(Ks,{class:"mt-6",variant:"accordion"},{default:a(()=>[n(ut,null,{default:a(()=>[n(ct,null,{default:a(()=>[o("div",za,[n(T,{class:"mr-3",color:"warning"},{default:a(()=>[...d[53]||(d[53]=[r(" mdi-help-circle ",-1)])]),_:1}),d[54]||(d[54]=o("span",{class:"text-subtitle-1 font-weight-medium"},"我以前已经使用过 Classworks KV？",-1))])]),_:1}),n(mt,null,{default:a(()=>[n(L,{variant:"tonal",color:"success",class:"pa-4"},{default:a(()=>[...d[55]||(d[55]=[o("div",{class:"text-body-2 mb-2"},[r(" 如果您之前已经使用过 Classworks KV，可以直接使用您的 "),o("strong",null,"UUID（命名空间）"),r(" 和 "),o("strong",null,"设置的密码"),r(" 进行认证。 ")],-1),o("div",{class:"text-body-2"},' 返回上一页，点击"已注册"按钮，输入您的认证信息即可登录。 ',-1)])]),_:1})]),_:1})]),_:1}),n(ut,null,{default:a(()=>[n(ct,null,{default:a(()=>[o("div",Pa,[n(T,{class:"mr-3",color:"info"},{default:a(()=>[...d[56]||(d[56]=[r(" mdi-help-circle ",-1)])]),_:1}),d[57]||(d[57]=o("span",{class:"text-subtitle-1 font-weight-medium"},"我如何配置不同类型的设备？",-1))])]),_:1}),n(mt,null,{default:a(()=>[n(L,{variant:"tonal",color:"info",class:"pa-4"},{default:a(()=>[...d[58]||(d[58]=[o("div",{class:"text-body-2 mb-2"},[r(" 不同的密码对应不同的设备类型，这将由 "),o("strong",null,"管理员管理"),r("。 ")],-1),o("div",{class:"text-body-2 mb-2"}," 例如： ",-1),o("ul",{class:"text-body-2 ml-4"},[o("li",{class:"mb-1"}," 班级大屏使用一个密码 "),o("li",{class:"mb-1"}," 教师设备使用另一个密码 "),o("li",null,"学生设备使用不同的密码")],-1),o("div",{class:"text-body-2 mt-3"}," 请联系您的管理员获取对应设备类型的密码。 ",-1)])]),_:1})]),_:1})]),_:1})]),_:1})],512),[[we,s.value===4&&i.value==="cloud"]])]),_:1}),n(fe,{class:"pa-6 pt-0"},{default:a(()=>[s.value>1?(f(),C(k,{key:0,size:"large",variant:"text",onClick:m},{default:a(()=>[n(T,{start:""},{default:a(()=>[...d[59]||(d[59]=[r(" mdi-chevron-left ",-1)])]),_:1}),d[60]||(d[60]=r(" 上一步 ",-1))]),_:1})):_("",!0),n(ne),s.value<4?(f(),C(k,{key:1,disabled:s.value===3&&!i.value,size:"large",color:"primary",variant:"elevated",onClick:c},{default:a(()=>[d[62]||(d[62]=r(" 下一步 ",-1)),n(T,{end:""},{default:a(()=>[...d[61]||(d[61]=[r(" mdi-chevron-right ",-1)])]),_:1})]),_:1},8,["disabled"])):(f(),C(k,{key:2,size:"large",color:"primary",variant:"elevated",onClick:v},{default:a(()=>[...d[63]||(d[63]=[r(" 关闭 ",-1)])]),_:1}))]),_:1})]),_:1}))}},Fa=ue(Aa,[["__scopeId","data-v-1e0254f3"]]),Na={key:0,class:"init-overlay"},Ra={class:"init-container"},Ea={class:"main-card-row"},Ba={class:"card-horizontal-layout"},Ma={class:"card-icon-wrapper"},ja={class:"card-horizontal-layout"},Ua={class:"card-icon-wrapper"},Oa={class:"card-horizontal-layout"},$a={class:"card-icon-wrapper"},Ka={class:"options-buttons"},Ha={__name:"InitServiceChooser",emits:["done"],setup(t,{emit:e}){const l=e,u=E(!1),s=E(!1),i=E(!1),c=E(!1),m=E(!1),p=K(()=>S("server.provider")),v=K(()=>p.value==="kv-server"||p.value==="classworkscloud"),y=K(()=>S("server.kvToken")),D=()=>{const V=window.location.pathname,w=V==="/"||V==="/index"||V==="/index.html",R=v.value&&(!y.value||y.value==="");u.value=w&&R};gt(()=>{D()});const d=()=>{const V=S("server.authDomain"),w="d158067f53627d2b98babe8bffd2fd7d",R=window.location.origin,he=encodeURIComponent(`${R}/authorizecallback`),M=S("device.uuid")||"00000000-0000-4000-8000-000000000000";let P=`${V}/authorize?app_id=${w}&mode=callback&callback_url=${he}&remark=Classworks 自动授权 来自${window.location.hostname} ${new Date().toLocaleString()}`;M!=="00000000-0000-4000-8000-000000000000"&&(P+=`&uuid=${encodeURIComponent(M)}`),window.location.href=P},B=()=>{i.value=!1,D(),l("done")},Q=()=>{c.value=!1,D(),l("done")},h=V=>{console.log("替代代码:",V),m.value=!1},N=()=>{me("server.provider","kv-local"),u.value=!1,window.location.reload(),l("done")},U=()=>{window.open(S("server.authDomain"),"_blank")};return(V,w)=>u.value?(f(),x("div",Na,[o("div",Ra,[w[22]||(w[22]=o("div",{class:"init-header"},[o("div",{class:"title"}," 欢迎使用 Classworks "),o("div",{class:"subtitle"}," 请选择你的使用方式 ")],-1)),o("div",Ea,[n(L,{class:"main-service-card gradient-new clickable",elevation:"4",onClick:w[0]||(w[0]=R=>s.value=!0)},{default:a(()=>[n(Oe,null,{default:a(()=>[o("div",Ba,[o("div",Ma,[n(T,{size:"48",color:"primary"},{default:a(()=>[...w[12]||(w[12]=[r(" mdi-new-box ",-1)])]),_:1})]),w[13]||(w[13]=o("div",{class:"card-content"},[o("div",{class:"text-h6 font-weight-bold"}," 初次使用 "),o("div",{class:"text-body-2 text-medium-emphasis mt-1"}," 了解 Classworks KV 并开始使用 ")],-1))])]),_:1})]),_:1}),n(L,{class:"main-service-card gradient-registered clickable",elevation:"4",onClick:w[1]||(w[1]=R=>i.value=!0)},{default:a(()=>[n(Oe,null,{default:a(()=>[o("div",ja,[o("div",Ua,[n(T,{size:"48",color:"success"},{default:a(()=>[...w[14]||(w[14]=[r(" mdi-account-check ",-1)])]),_:1})]),w[15]||(w[15]=o("div",{class:"card-content"},[o("div",{class:"text-h6 font-weight-bold"}," 已注册 "),o("div",{class:"text-body-2 text-medium-emphasis mt-1"}," 使用设备 Namespace 登录 ")],-1))])]),_:1})]),_:1}),n(L,{class:"main-service-card clickable",elevation:"4",onClick:U},{default:a(()=>[n(Oe,null,{default:a(()=>[o("div",Oa,[o("div",$a,[n(T,{size:"48",color:"info"},{default:a(()=>[...w[16]||(w[16]=[r(" mdi-database-cog ",-1)])]),_:1})]),w[17]||(w[17]=o("div",{class:"card-content"},[o("div",{class:"text-h6 font-weight-bold"}," Classworks KV "),o("div",{class:"text-body-2 text-medium-emphasis mt-1"}," 打开云端控制台管理数据 ")],-1))])]),_:1})]),_:1})]),o("div",Ka,[n(k,{variant:"tonal","prepend-icon":"mdi-laptop",size:"small",onClick:N},{default:a(()=>[...w[18]||(w[18]=[r(" 使用本地模式 ",-1)])]),_:1}),n(k,{variant:"tonal","prepend-icon":"mdi-flash",size:"small",onClick:d},{default:a(()=>[...w[19]||(w[19]=[r(" 授权码式授权（弃用） ",-1)])]),_:1}),n(k,{variant:"tonal","prepend-icon":"mdi-key",size:"small",onClick:w[2]||(w[2]=R=>c.value=!0)},{default:a(()=>[...w[20]||(w[20]=[r(" 输入 Token ",-1)])]),_:1}),n(k,{variant:"tonal","prepend-icon":"mdi-code-tags",size:"small",onClick:w[3]||(w[3]=R=>m.value=!0)},{default:a(()=>[...w[21]||(w[21]=[r(" 输入替代代码 ",-1)])]),_:1})]),w[23]||(w[23]=o("div",{class:"footer-hint"}," 完成授权后可使用作业同步、考试看板等在线功能。 ",-1))]),n(de,{modelValue:s.value,"onUpdate:modelValue":w[5]||(w[5]=R=>s.value=R),"max-width":"600"},{default:a(()=>[n(Fa,{onClose:w[4]||(w[4]=R=>s.value=!1)})]),_:1},8,["modelValue"]),n(de,{modelValue:i.value,"onUpdate:modelValue":w[7]||(w[7]=R=>i.value=R),"max-width":"500"},{default:a(()=>[n(ea,{"show-cancel":!0,onSuccess:B,onCancel:w[6]||(w[6]=R=>i.value=!1)})]),_:1},8,["modelValue"]),n(de,{modelValue:c.value,"onUpdate:modelValue":w[9]||(w[9]=R=>c.value=R),"max-width":"500"},{default:a(()=>[n(ta,{"show-cancel":!0,onSuccess:Q,onCancel:w[8]||(w[8]=R=>c.value=!1)})]),_:1},8,["modelValue"]),n(de,{modelValue:m.value,"onUpdate:modelValue":w[11]||(w[11]=R=>m.value=R),"max-width":"500"},{default:a(()=>[n(sa,{"show-cancel":!0,onSubmit:h,onCancel:w[10]||(w[10]=R=>m.value=!1)})]),_:1},8,["modelValue"])])):_("",!0)}},At=ue(Ha,[["__scopeId","data-v-433d390d"]]);function ht(t,e){let l=null;return function(...u){l&&clearTimeout(l),l=setTimeout(()=>{t.apply(this,u)},e)}}function qa(t,e){let l=null,u=0;return function(...s){const i=Date.now();i-u<e?(l&&clearTimeout(l),l=setTimeout(()=>{u=i,t.apply(this,s)},e)):(u=i,t.apply(this,s))}}const Ga={name:"Classworks 作业板",components:{MessageLog:Dt,RandomPicker:Vt,FloatingToolbar:Lt,FloatingICP:_t,HomeworkEditDialog:It,InitServiceChooser:At,ChatWidget:Tt,StudentNameManager:zt},data(){const t=[{name:"语文",order:0},{name:"数学",order:1},{name:"英语",order:2},{name:"物理",order:3},{name:"化学",order:4},{name:"生物",order:5},{name:"政治",order:6},{name:"历史",order:7},{name:"地理",order:8},{name:"其他",order:9}];return{dataKey:"",provider:"",useDisplay:rt,state:{classNumber:"",studentList:[],boardData:{homework:{},attendance:{absent:[],late:[],exclude:[]}},dialogVisible:!1,dialogTitle:"",textarea:"",dateString:"",synced:!1,attendDialogVisible:!1,contentStyle:{"font-size":`${S("font.size")}px`},uploadLoading:!1,downloadLoading:!1,snackbar:!1,snackbarText:"",fontSize:S("font.size"),datePickerDialog:!1,selectedDate:new Date().toISOString().split("T")[0].replace(/-/g,""),selectedDateObj:new Date,refreshInterval:null,showNoDataMessage:!1,noDataMessage:"",isToday:!1,attendanceDialog:!1,availableSubjects:t,isFullscreen:!1},loading:{download:!1,upload:!1,students:!1},debouncedUpload:null,throttledReflow:null,sortedItemsCache:{key:"",value:[]},confirmDialog:{show:!1,resolve:null,reject:null},attendanceSearch:"",attendanceFilter:[],urlConfigDialog:{show:!1,config:null,changes:[],validSettings:{},confirmHandler:null,cancelHandler:null,icons:{}},settingsTick:0,isChatOpen:!1,highlightedCards:{},tokenDisplayInfo:{show:!1,readonly:!1,text:"",color:"primary",variant:"tonal",icon:"mdi-account",disabled:!1},realtimeInfo:{show:!1,time:"",key:""},$offKvChanged:null,$offConnect:null,debouncedRealtimeRefresh:null}},computed:{isMobile(){return rt().mobile.value},titleText(){const t=this.getToday(),e=new Date(t);e.setDate(e.getDate()-1);const l=this.state.dateString,u=this.formatDate(t),s=this.formatDate(e);return l===u?"今天的作业":l===s?"昨天的作业":`${l}的作业`},sortedItems(){const t=`${JSON.stringify(this.state.boardData.homework)}_${this.subjectOrder.join()}_${this.dynamicSort}`;if(this.sortedItemsCache.key===t)return this.sortedItemsCache.value;const e=Object.entries(this.state.boardData.homework).filter(([,u])=>{var s;return(s=u.content)==null?void 0:s.trim()}).map(([u,s])=>{var i;return{key:u,name:((i=this.state.availableSubjects.find(c=>c.name===u))==null?void 0:i.name)||u,content:s.content,order:this.subjectOrder.indexOf(u),rowSpan:Math.ceil((s.content.split(`
`).filter(c=>c.trim()).length+1)*.8)}}),l=this.dynamicSort?this.optimizeGridLayout(e):e.sort((u,s)=>u.order-s.order);return this.updateSortedItemsCache(t,l),l},unusedSubjects(){const t=Object.keys(this.state.boardData.homework).filter(e=>{var l;return(l=this.state.boardData.homework[e].content)==null?void 0:l.trim()});return this.state.availableSubjects.filter(e=>!t.includes(e.name)).sort((e,l)=>e.order-l.order)},emptySubjects(){return this.emptySubjectDisplay!=="button"?[]:this.unusedSubjects},autoSave(){return S("edit.autoSave")},blockNonTodayAutoSave(){return S("edit.blockNonTodayAutoSave")},isToday(){const t=(()=>{const e=new Date,l=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${l}${u}${s}`})();return this.state.dateString===t},canAutoSave(){return this.autoSave&&(!this.blockNonTodayAutoSave||this.isToday)},needConfirmSave(){return!this.isToday&&this.confirmNonTodaySave},shouldShowBlockedMessage(){return!this.isToday&&this.autoSave&&this.blockNonTodayAutoSave},refreshBeforeEdit(){return S("edit.refreshBeforeEdit")},emptySubjectDisplay(){return S("display.emptySubjectDisplay")},dynamicSort(){return S("display.dynamicSort")},isEditingDisabled(){return this.state.uploadLoading||this.state.downloadLoading},unreadCount(){var t;return((t=this.$refs.messageLog)==null?void 0:t.unreadCount)||0},showRandomPickerButton(){return S("randomPicker.enabled")},showListCardButton(){return S("display.showListCard")},confirmNonTodaySave(){return S("edit.confirmNonTodaySave")},shouldShowSaveConfirm(){return!this.isToday&&this.confirmNonTodaySave},shouldBlockAutoSave(){return!this.isToday&&this.autoSave&&this.blockNonTodayAutoSave},showFullscreenButton(){return S("display.showFullscreenButton")},showExamScheduleButton(){return S("display.showExamScheduleButton")},showAntiScreenBurnCard(){return S("display.showAntiScreenBurnCard")},shouldShowInit(){var s;const t=S("server.provider"),e=t==="kv-server"||t==="classworkscloud",l=S("server.kvToken"),u=((s=this.$route)==null?void 0:s.path)==="/";return this.settingsTick,u&&e&&(!l||l==="")},filteredStudents(){let t=[...this.state.studentList];if(this.attendanceSearch){const e=this.attendanceSearch.toLowerCase();t=t.filter(l=>l.toLowerCase().includes(e))}return this.attendanceFilter&&this.attendanceFilter.length>0&&(t=t.filter(e=>{const l=this.state.studentList.indexOf(e);return!!(this.attendanceFilter.includes("present")&&this.isPresent(l)||this.attendanceFilter.includes("absent")&&this.isAbsent(l)||this.attendanceFilter.includes("late")&&this.isLate(l)||this.attendanceFilter.includes("exclude")&&this.isExclude(l))})),t},extractedSurnames(){if(!this.state.studentList||this.state.studentList.length===0)return[];const t=new Map;return this.state.studentList.forEach(e=>{if(e&&e.length>0){const l=e.charAt(0);t.has(l)?t.set(l,t.get(l)+1):t.set(l,1)}}),Array.from(t.entries()).map(([e,l])=>({name:e,count:l})).sort((e,l)=>{const u=dt(e.name,{toneType:"none",mode:"surname"}),s=dt(l.name,{toneType:"none",mode:"surname"});return u.localeCompare(s)})},subjectOrder(){return[...this.state.availableSubjects].sort((t,e)=>t.order-e.order).map(t=>t.name)}},watch:{homeworkData:{handler(){this.$nextTick(()=>{this.$refs.waterfall&&this.$refs.waterfall.reflow()})},deep:!0},"$vuetify.display.width":{handler(){this.throttledReflow()},deep:!0}},created(){this.debouncedUpload=ht(this.uploadData,2e3),this.throttledReflow=qa(()=>{this.$refs.gridContainer&&this.optimizeGridLayout(this.sortedItems)},200)},async mounted(){try{this.updateBackendUrl(),await this.initializeData(),this.setupAutoRefresh(),this.unwatchSettings=pt(()=>{this.updateSettings()}),this.$nextTick(()=>{const t=this.$refs.studentNameManager;t&&(this.studentNameInfo.name=t.currentStudentName,this.studentNameInfo.isStudent=t.isStudentToken,this.studentNameInfo.openDialog=()=>t.openDialog(),this.$watch(()=>t.currentStudentName,e=>{this.studentNameInfo.name=e}),this.$watch(()=>t.isStudentToken,e=>{this.studentNameInfo.isStudent=e}))}),document.addEventListener("fullscreenchange",this.fullscreenChangeHandler),document.addEventListener("webkitfullscreenchange",this.fullscreenChangeHandler),document.addEventListener("mozfullscreenchange",this.fullscreenChangeHandler),document.addEventListener("MSFullscreenChange",this.fullscreenChangeHandler),this.checkHashForRandomPicker(),window.addEventListener("hashchange",this.checkHashForRandomPicker),this.setupRealtimeChannel(),this.$nextTick(()=>{this.updateTokenDisplayInfo()})}catch(t){console.error("初始化失败:",t),this.showError("初始化失败，请刷新页面重试")}},beforeUnmount(){this.unwatchSettings&&this.unwatchSettings(),this.state.refreshInterval&&clearInterval(this.state.refreshInterval),document.removeEventListener("fullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("webkitfullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("mozfullscreenchange",this.fullscreenChangeHandler),document.removeEventListener("MSFullscreenChange",this.fullscreenChangeHandler),window.removeEventListener("hashchange",this.checkHashForRandomPicker);try{this.$offKvChanged&&this.$offKvChanged(),this.$offConnect&&this.$offConnect(),Ps()}catch{}},methods:{updateTokenDisplayInfo(){const t=this.$refs.studentNameManager;if(!t||!t.hasToken){this.tokenDisplayInfo.show=!1,this.tokenDisplayInfo.readonly=!1;return}const e=t.displayName,l=t.isReadOnly,u=t.isStudentToken;if(this.tokenDisplayInfo.readonly=l,!u){this.tokenDisplayInfo.show=!1;return}this.tokenDisplayInfo.text=e,this.tokenDisplayInfo.color="primary",this.tokenDisplayInfo.icon="mdi-account",this.tokenDisplayInfo.disabled=l,this.tokenDisplayInfo.show=!0},handleTokenChipClick(){console.log("Token chip clicked");const t=this.$refs.studentNameManager;console.log("Manager:",t),console.log("Is student token:",t==null?void 0:t.isStudentToken),t&&t.isStudentToken?(console.log("Opening dialog..."),t.openDialog()):console.log("Cannot open dialog - conditions not met")},ensureDate(t){if(t instanceof Date)return t;if(typeof t=="string"){const e=new Date(t);if(!isNaN(e.getTime()))return e}return new Date},formatDate(t){const e=this.ensureDate(t),l=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${l}${u}${s}`},getToday(){return new Date},async initializeData(){const t=await this.parseUrlConfig(),l=new URLSearchParams(window.location.search).get("date"),u=this.getToday();let s=u;if(l){if(/^\d{8}$/.test(l)){const i=l.substring(0,4),c=l.substring(4,6),m=l.substring(6,8);s=new Date(`${i}-${c}-${m}`)}else s=new Date(l);isNaN(s.getTime())&&(s=u)}if(this.state.dateString=this.formatDate(s),this.state.selectedDate=this.state.dateString,this.state.selectedDateObj=s,this.state.isToday=this.formatDate(s)===this.formatDate(u),!t){this.provider=S("server.provider");const i=S("server.classNumber");this.state.classNumber=i}await Promise.all([this.downloadData(),this.loadConfig()])},async downloadData(){var t,e,l;if(!this.loading.download)try{this.loading.download=!0;const u=await Ce.loadData("classworks-data-"+this.state.dateString);if(u.success==!1)if(u.error.code==="NOT_FOUND")this.state.showNoDataMessage=!0,this.state.noDataMessage=u.error.message,this.state.boardData={homework:{},attendance:{absent:[],late:[],exclude:[]}};else throw new Error(u.error.message);else this.state.boardData={homework:u.homework||{},attendance:{absent:((t=u.attendance)==null?void 0:t.absent)||[],late:((e=u.attendance)==null?void 0:e.late)||[],exclude:((l=u.attendance)==null?void 0:l.exclude)||[]}},this.state.synced=!0,this.state.showNoDataMessage=!1,this.$message.success("下载成功","数据已更新")}catch(u){this.state.boardData={homework:{},attendance:{absent:[],late:[],exclude:[]}},this.$message.error("下载失败",u.message)}finally{this.loading.download=!1}},async trySave(t=!1){if(t&&!this.canAutoSave)return this.shouldShowBlockedMessage&&this.showMessage("需要手动保存","已禁止自动保存非当天数据","warning"),!1;if(!t&&this.needConfirmSave)try{await this.showConfirmDialog()}catch{return!1}try{return await this.uploadData(),!0}catch(e){return this.$message.error("保存失败",e.message||"请重试"),!1}},async handleClose(){var l;if(!this.currentEditSubject)return;const t=this.state.textarea.trim(),e=((l=this.state.boardData.homework[this.currentEditSubject])==null?void 0:l.content)||"";t!==e.trim()&&(this.state.boardData.homework[this.currentEditSubject]={content:t},this.state.synced=!1,this.autoSave&&await this.trySave(!0)),this.state.dialogVisible=!1},async uploadData(){if(!this.loading.upload)try{this.loading.upload=!0;const t=await Ce.saveData("classworks-data-"+this.state.dateString,this.state.boardData);if(t.success==!1)throw new Error(t.error.message);this.state.synced=!0,this.$message.success(t.message||"保存成功")}finally{this.loading.upload=!1}},async loadConfig(){try{try{const t=await Ce.loadData("classworks-list-main");t.success!=!1&&Array.isArray(t)&&(this.state.studentList=t.map(e=>e.name))}catch(t){console.warn("Failed to load student list from dedicated key, falling back to config",t)}await this.loadSubjects()}catch(t){console.error("加载配置失败:",t),this.$message.error("加载配置失败",t.message)}},async loadSubjects(){try{const t=await Ce.loadData("classworks-config-subject");t&&Array.isArray(t)&&(this.state.availableSubjects=t)}catch(t){console.warn("Failed to load subject configuration:",t)}},showSyncMessage(){this.$message.success("数据已同步","数据已完成与服务器同步")},async openDialog(t){var e;if(this.refreshBeforeEdit)try{await this.downloadData()}catch(l){console.error("刷新数据失败:",l),this.$message.error("刷新数据失败，可能显示的不是最新数据")}this.currentEditSubject=t,this.state.boardData.homework[t]||(this.state.boardData.homework[t]={content:""}),this.state.dialogTitle=((e=this.state.availableSubjects.find(l=>l.name===t))==null?void 0:e.name)||t,this.state.textarea=this.state.boardData.homework[t].content,this.state.dialogVisible=!0},async handleHomeworkSave(t){this.currentEditSubject&&(this.state.boardData.homework[this.currentEditSubject]={content:t},this.state.synced=!1,this.autoSave&&await this.trySave(!0))},splitPoint(t){return t.split(`
`).filter(e=>e.trim())},setAttendanceArea(){this.state.attendanceDialog=!0},toggleStudentStatus(t){const e=this.state.studentList[t];this.state.boardData.attendance.absent.includes(e)?(this.state.boardData.attendance.absent=this.state.boardData.attendance.absent.filter(l=>l!==e),this.state.boardData.attendance.late.push(e)):this.state.boardData.attendance.late.includes(e)?(this.state.boardData.attendance.late=this.state.boardData.attendance.late.filter(l=>l!==e),this.state.boardData.attendance.exclude.push(e)):this.state.boardData.attendance.exclude.includes(e)?this.state.boardData.attendance.exclude=this.state.boardData.attendance.exclude.filter(l=>l!==e):this.state.boardData.attendance.absent.push(e),this.state.synced=!1,this.canAutoSave&&this.uploadData()},cleanstudentslist(){this.state.boardData.attendance.absent=[],this.state.boardData.attendance.late=[],this.state.boardData.attendance.exclude=[],this.state.synced=!1,this.canAutoSave&&this.uploadData()},zoom(t){t==="up"&&this.state.fontSize<100?this.state.fontSize+=2:t==="out"&&this.state.fontSize>16&&(this.state.fontSize-=2),this.state.contentStyle={"font-size":`${this.state.fontSize}px`},me("font.size",this.state.fontSize)},updateBackendUrl(){const t=S("server.provider"),e=S("server.classNumber");this.provider=t,this.state.classNumber=e},setupAutoRefresh(){const t=S("refresh.auto"),e=S("refresh.interval");this.state.refreshInterval&&clearInterval(this.state.refreshInterval),t&&(this.state.refreshInterval=setInterval(()=>{this.shouldSkipRefresh()||this.downloadData()},e*1e3))},shouldSkipRefresh(){return!!(this.state.dialogVisible||this.state.attendanceDialog||this.confirmDialog.show||this.state.datePickerDialog||this.loading.upload||this.loading.download||!this.state.synced)},updateSettings(){this.state.fontSize=S("font.size"),this.state.contentStyle={"font-size":`${this.state.fontSize}px`},this.setupAutoRefresh(),this.updateBackendUrl(),this.settingsTick++},async handleDateSelect(t){if(t)try{const e=this.ensureDate(t),l=this.formatDate(e);this.state.dateString!==l&&(this.state.dateString=l,this.state.selectedDate=l,this.state.selectedDateObj=e,this.state.isToday=l===this.formatDate(this.getToday()),this.$router.replace({query:{date:l}}).catch(()=>{}),await Promise.all([this.downloadData(),this.loadSubjects()]))}catch(e){console.error("Date processing error:",e),this.$message.error("日期处理错误","请重新选择日期")}},optimizeGridLayout(t){const e=Math.min(3,Math.floor(window.innerWidth/300));if(e<=1)return t;const l=Array.from({length:e},()=>({height:0,items:[]}));return t.forEach(u=>{const s=l.reduce((i,c,m)=>c.height<l[i].height?m:i,0);l[s].items.push(u),l[s].height+=u.rowSpan}),l.flatMap(u=>u.items).map((u,s)=>({...u,order:s}))},setupRealtimeChannel(){try{const t=S("server.kvToken");if(!t){console.warn("未配置 KV Token，无法加入实时频道");return}He(),qe(t),this.$offConnect=zs(()=>qe(t)),this.debouncedRealtimeRefresh||(this.debouncedRealtimeRefresh=ht(async()=>{var p,v,y;const l=JSON.parse(JSON.stringify(this.state.boardData.homework));await this.downloadData();const u=new Date,s=String(u.getHours()).padStart(2,"0"),i=String(u.getMinutes()).padStart(2,"0"),c=String(u.getSeconds()).padStart(2,"0");(p=this.$message)==null||p.info("数据已更新",`已于 ${s}:${i}:${c} 自动刷新`);const m={};for(const D in this.state.boardData.homework){const d=((v=l[D])==null?void 0:v.content)||"",B=((y=this.state.boardData.homework[D])==null?void 0:y.content)||"";d!==B&&(m[D]=!0)}for(const D in l)this.state.boardData.homework[D]||(m[D]=!0);this.highlightedCards=m,setTimeout(()=>{this.highlightedCards={}},1e4)},800));const e=l=>{var s;if(!l)return;const u=`classworks-data-${this.state.dateString}`;l.key===u&&(l.action!=="upsert"&&l.action!=="delete"||(s=this.debouncedRealtimeRefresh)==null||s.call(this,l.key))};this.$offKvChanged=St("kv-key-changed",e)}catch(t){console.warn("实时频道初始化失败",t)}},setAllPresent(){this.state.boardData.attendance={absent:[],late:[],exclude:[]},this.state.synced=!1},setAllAbsent(){this.state.boardData.attendance.absent=[...this.state.studentList],this.state.boardData.attendance.late=[],this.state.boardData.attendance.exclude=[],this.state.synced=!1},setAllLate(){this.state.boardData.attendance.absent=[],this.state.boardData.attendance.late=[...this.state.studentList],this.state.boardData.attendance.exclude=[],this.state.synced=!1},setAllExclude(){this.state.boardData.attendance.absent=[],this.state.boardData.attendance.late=[],this.state.boardData.attendance.exclude=[...this.state.studentList],this.state.synced=!1},isPresent(t){const e=this.state.studentList[t],{absent:l,late:u,exclude:s}=this.state.boardData.attendance;return!l.includes(e)&&!u.includes(e)&&!s.includes(e)},isAbsent(t){return this.state.boardData.attendance.absent.includes(this.state.studentList[t])},isLate(t){return this.state.boardData.attendance.late.includes(this.state.studentList[t])},isExclude(t){return this.state.boardData.attendance.exclude.includes(this.state.studentList[t])},setPresent(t){const e=this.state.studentList[t];this.state.boardData.attendance.absent=this.state.boardData.attendance.absent.filter(l=>l!==e),this.state.boardData.attendance.late=this.state.boardData.attendance.late.filter(l=>l!==e),this.state.boardData.attendance.exclude=this.state.boardData.attendance.exclude.filter(l=>l!==e),this.state.synced=!1},setAbsent(t){const e=this.state.studentList[t];this.setPresent(t),this.state.boardData.attendance.absent.push(e),this.state.synced=!1},setLate(t){const e=this.state.studentList[t];this.setPresent(t),this.state.boardData.attendance.late.push(e),this.state.synced=!1},setExclude(t){const e=this.state.studentList[t];this.setPresent(t),this.state.boardData.attendance.exclude.push(e),this.state.synced=!1},async saveAttendance(){try{await this.trySave(!0),this.state.attendanceDialog=!1}catch(t){console.error("保存出勤状态失败:",t),this.$message.error("保存失败","请重试")}},showMessage(t,e="",l="success"){this.$message[l](t,e)},updateSortedItemsCache(t,e){this._sortedItemsCache={key:t,value:e}},handleMouseMove(t){const e=t.currentTarget,l=e.getBoundingClientRect(),u=(t.clientX-l.left)/l.width*100,s=(t.clientY-l.top)/l.height*100;e.style.setProperty("--x",`${u}%`),e.style.setProperty("--y",`${s}%`)},handleTouchMove(t){if(t.touches.length===1){const e=t.touches[0],l=t.currentTarget,u=l.getBoundingClientRect(),s=(e.clientX-u.left)/u.width*100,i=(e.clientY-u.top)/u.height*100;l.style.setProperty("--x",`${s}%`),l.style.setProperty("--y",`${i}%`)}},showConfirmDialog(){return new Promise((t,e)=>{this.confirmDialog={show:!0,resolve:()=>{this.confirmDialog.show=!1,t()},reject:()=>{this.confirmDialog.show=!1,e(new Error("用户取消保存"))}}})},confirmSave(){this.confirmDialog.show=!1,this.confirmDialog.resolve&&this.confirmDialog.resolve(!0)},cancelSave(){this.confirmDialog.show=!1,this.confirmDialog.reject&&this.confirmDialog.reject(new Error("用户取消保存"))},async manualUpload(){return this.trySave(!1)},async handleAttendanceDialogClose(t){!t&&!this.state.synced&&await this.trySave(!0)},toggleFullscreen(){this.state.isFullscreen?this.exitFullscreen():this.enterFullscreen()},enterFullscreen(){const t=document.documentElement;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullScreen?t.webkitRequestFullScreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen()},exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},fullscreenChangeHandler(){this.state.isFullscreen=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)},getStudentStatusColor(t){const e=this.state.studentList[t];return this.state.boardData.attendance.absent.includes(e)?"error":this.state.boardData.attendance.late.includes(e)?"warning":this.state.boardData.attendance.exclude.includes(e)?"grey":"success"},getStudentStatusVariant(t){const e=this.state.studentList[t];return this.state.boardData.attendance.absent.includes(e)||this.state.boardData.attendance.late.includes(e)||this.state.boardData.attendance.exclude.includes(e)?"tonal":"outlined"},getStudentStatusIcon(t){const e=this.state.studentList[t];return this.state.boardData.attendance.absent.includes(e)?"mdi-account-off":this.state.boardData.attendance.late.includes(e)?"mdi-clock-alert":this.state.boardData.attendance.exclude.includes(e)?"mdi-account-cancel":"mdi-account-check"},getStudentStatusText(t){const e=this.state.studentList[t];return this.state.boardData.attendance.absent.includes(e)?"请假":this.state.boardData.attendance.late.includes(e)?"迟到":this.state.boardData.attendance.exclude.includes(e)?"不参与":"到课"},toggleFilter(t){const e=this.attendanceFilter.indexOf(t);e===-1?this.attendanceFilter.push(t):this.attendanceFilter.splice(e,1)},openRandomPicker(){this.$refs.randomPicker&&this.$refs.randomPicker.open()},checkHashForRandomPicker(){window.location.hash==="#random-picker"&&this.$nextTick(()=>{console.log("打开随机点名"),window.location.hash="",this.openRandomPicker()})},parseUrlConfig(){try{const e=new URLSearchParams(window.location.search).get("config");if(!e)return!1;try{const l=atob(e),u=Uint8Array.from(l,v=>v.charCodeAt(0)),s=new TextDecoder().decode(u),i=JSON.parse(s);console.log("从URL读取配置:",i);const c=[],m={},p={};return this.processSpecialSettings(i,c,m),this.processStandardSettings(i,c,m,p),Object.keys(m).length===0?(console.log("URL配置与当前配置相同，无需应用"),!1):new Promise(v=>{this.urlConfigDialog={show:!0,config:i,changes:c,validSettings:m,icons:p,confirmHandler:()=>{this.urlConfigDialog.show=!1,this.applyUrlConfig(m),v(!0)},cancelHandler:()=>{this.urlConfigDialog.show=!1,v(!1)}}})}catch(l){return console.error("解析URL配置错误:",l),this.$message.error("URL配置错误","无法解析配置数据"),!1}}catch(t){return console.error("处理URL配置错误:",t),!1}},processSpecialSettings(t,e,l){var u,s;if(t.classNumber!==void 0){const i=S("server.classNumber");t.classNumber!==i&&(e.push({key:"server.classNumber",name:"班级",oldValue:i,newValue:t.classNumber,description:((u=Ve["server.classNumber"])==null?void 0:u.description)||"班级编号",icon:((s=Ve["server.classNumber"])==null?void 0:s.icon)||"mdi-account-group"}),l["server.classNumber"]=t.classNumber)}t.date!==void 0&&t.date!==this.state.dateString&&(e.push({key:"date",name:"日期",oldValue:this.state.dateString,newValue:t.date,description:"查看的日期",icon:"mdi-calendar"}),l.date=t.date),t.subjects&&Array.isArray(t.subjects)&&(e.push({key:"subjects",name:"科目列表",oldValue:`${this.state.availableSubjects.length}个科目`,newValue:`${t.subjects.length}个科目`,description:"可用科目列表",icon:"mdi-notebook"}),l.subjects=t.subjects)},processStandardSettings(t,e,l,u){Object.entries(t).forEach(([s,i])=>{if(["classNumber","date","subjects"].includes(s))return;let c=s,m=Ve[s];if(!m&&!s.includes(".")){const p=["server.","display.","theme.","edit.","refresh.","font.","randomPicker."];for(const v of p){const y=`${v}${s}`;if(Ve[y]){c=y,m=Ve[y];break}}}if(m){let p=this.convertValueToCorrectType(i,m.type);if(m.validate&&!m.validate(p)){console.warn(`URL配置项 ${c} 的值无效: ${i}`);return}const v=S(c);p!==v&&(e.push({key:c,name:this.getSettingDisplayName(c),oldValue:this.formatSettingValue(v),newValue:this.formatSettingValue(p),description:m.description||c,icon:m.icon||"mdi-cog"}),l[c]=p,u[c]=m.icon||"mdi-cog")}else e.push({key:s,name:this.getSettingDisplayName(s),oldValue:"未知",newValue:this.formatSettingValue(i),description:"自定义配置项",icon:"mdi-cog-outline"}),l[s]=i,u[s]="mdi-cog-outline"})},convertValueToCorrectType(t,e){return e==="boolean"?!!t:e==="number"?Number(t):String(t)},formatSettingValue(t){return typeof t=="boolean"?t?"开启":"关闭":t===""||t===null||t===void 0?"空":t.toString()},getSettingDisplayName(t){const e=t.split("."),l=e[e.length-1];return{provider:"数据提供方",domain:"服务器域名",classNumber:"班级编号",emptySubjectDisplay:"空科目显示方式",dynamicSort:"动态排序",showRandomButton:"随机按钮",showFullscreenButton:"全屏按钮",cardHoverEffect:"卡片悬浮效果",enhancedTouchMode:"增强触摸模式",showAntiScreenBurnCard:"防烧屏卡片",mode:"主题模式",size:"字体大小",autoSave:"自动保存",blockNonTodayAutoSave:"禁止自动保存非当日",refreshBeforeEdit:"编辑前刷新",confirmNonTodaySave:"非当日保存确认",auto:"自动刷新",interval:"刷新间隔"}[l]||l},safeBase64Decode(t){try{return Ns.decode(t)}catch(e){throw console.error("Base64解码错误:",e),new Error("无法解码配置数据")}},applyUrlConfig(t){for(const[e,l]of Object.entries(t)){if(e==="date"){this.handleDateSelect(l);continue}if(e==="subjects"){this.state.availableSubjects=l;continue}me(e,l),e==="server.classNumber"&&(this.state.classNumber=l)}return this.updateBackendUrl(),this.$message.success("URL配置已应用","已从URL加载配置"),!0},navigateDay(t){const e=new Date(this.state.selectedDateObj);e.setDate(e.getDate()+t),this.handleDateSelect(e)}}},Ya={key:2,class:"d-flex"},Wa={ref:"gridContainer",class:"grid-masonry"},Ja={class:"empty-subjects mt-4"},Qa={key:1,class:"empty-subjects-grid"},Xa={key:0},Za={style:{"white-space":"nowrap"}},el={key:0},tl={style:{"white-space":"nowrap"}},sl={key:0},nl={style:{"white-space":"nowrap"}},al={class:"d-flex flex-wrap mt-2 gap-1"},ll={class:"d-flex flex-wrap mb-4 gap-2"},il={class:"flex-grow-1"},ol={class:"d-flex align-center"},rl={class:"text-subtitle-1"},dl={class:"attendance-actions"},ul={class:"text-subtitle-1"},cl={class:"text-grey-darken-1"},ml={class:"text-primary font-weight-medium"};function fl(t,e,l,u,s,i){const c=At,m=zt,p=Ds("snap"),v=It,y=Dt,D=Lt,d=_t,B=Tt,Q=Vt;return f(),x(z,null,[n(qs,{class:"no-select"},{append:a(()=>[s.tokenDisplayInfo.readonly?(f(),C(q,{key:0,color:"warning",variant:"tonal",class:"mx-2","prepend-icon":"mdi-lock-alert"},{default:a(()=>[...e[22]||(e[22]=[r(" 只读 ",-1)])]),_:1})):_("",!0),s.tokenDisplayInfo.show?(f(),C(q,{key:1,color:"primary",variant:"tonal",class:"mx-2","prepend-icon":"mdi-account",style:X({cursor:s.tokenDisplayInfo.disabled?"default":"pointer"}),onClick:i.handleTokenChipClick},{default:a(()=>[r(b(s.tokenDisplayInfo.text),1)]),_:1},8,["style","onClick"])):_("",!0),n(k,{icon:"mdi-chat",variant:"text",onClick:e[0]||(e[0]=h=>s.isChatOpen=!0)}),n(k,{icon:"mdi-bell",variant:"text",badge:i.unreadCount||void 0,"badge-color":i.unreadCount?"error":void 0,onClick:e[1]||(e[1]=h=>t.$refs.messageLog.drawer=!0)},null,8,["badge","badge-color"]),n(k,{icon:"mdi-cog",variant:"text",onClick:e[2]||(e[2]=h=>t.$router.push("/settings"))})]),default:a(()=>[n(Hs,null,{default:a(()=>[r(b(s.state.classNumber)+" - "+b(i.titleText),1)]),_:1}),n(ne)]),_:1}),i.shouldShowInit?(f(),C(c,{key:0,onDone:e[3]||(e[3]=h=>s.settingsTick++)})):_("",!0),i.shouldShowInit?_("",!0):(f(),C(m,{key:1,ref:"studentNameManager",onTokenInfoUpdated:i.updateTokenDisplayInfo},null,8,["onTokenInfoUpdated"])),i.shouldShowInit?_("",!0):(f(),x("div",Ya,[n(Gs,{class:"main-window flex-grow-1 no-select",fluid:""},{default:a(()=>[o("div",Wa,[n($e,{name:"grid"},{default:a(()=>[(f(!0),x(z,null,O(i.sortedItems,h=>(f(),x("div",{key:h.key,class:"grid-item",style:X({"grid-row-end":`span ${h.rowSpan}`,order:h.order})},[n(L,{border:"",height:"100%",class:ae(["glow-track",{"glow-highlight":s.highlightedCards[h.key]}]),onClick:N=>!i.isEditingDisabled&&i.openDialog(h.key),onMousemove:i.handleMouseMove,onTouchmove:i.handleTouchMove},{default:a(()=>[n(se,null,{default:a(()=>[r(b(h.name),1)]),_:2},1024),n(Y,{style:X(s.state.contentStyle)},{default:a(()=>[n(Ke,null,{default:a(()=>[(f(!0),x(z,null,O(i.splitPoint(h.content),N=>(f(),C(Ae,{key:N},{default:a(()=>[r(b(N),1)]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["style"])]),_:2},1032,["class","onClick","onMousemove","onTouchmove"])],4))),128))]),_:1})],512),o("div",Ja,[i.emptySubjectDisplay==="button"?(f(),C(Ie,{key:0,divided:"",variant:"tonal"},{default:a(()=>[(f(!0),x(z,null,O(i.unusedSubjects,h=>(f(),C(k,{key:h.name,disabled:i.isEditingDisabled,onClick:N=>i.openDialog(h.name)},{default:a(()=>[n(T,{start:""},{default:a(()=>[...e[23]||(e[23]=[r(" mdi-plus ",-1)])]),_:1}),r(" "+b(h.name),1)]),_:2},1032,["disabled","onClick"]))),128))]),_:1})):(f(),x("div",Qa,[n($e,{name:"v-list"},{default:a(()=>[(f(!0),x(z,null,O(i.unusedSubjects,h=>(f(),C(L,{key:h.name,border:"",class:"empty-subject-card",disabled:i.isEditingDisabled,onClick:N=>i.openDialog(h.name)},{default:a(()=>[n(se,{class:"text-subtitle-1"},{default:a(()=>[r(b(h.name),1)]),_:2},1024),n(Y,{class:"text-center"},{default:a(()=>[n(T,{size:"small",color:"grey"},{default:a(()=>[...e[24]||(e[24]=[r(" mdi-plus ",-1)])]),_:1}),e[25]||(e[25]=o("div",{class:"text-caption text-grey"},"点击添加作业",-1))]),_:1})]),_:2},1032,["disabled","onClick"]))),128))]),_:1})]))]),s.state.synced?(f(),C(k,{key:1,color:"success",size:"large",onClick:i.showSyncMessage},{default:a(()=>[...e[27]||(e[27]=[r(" 同步完成 ",-1)])]),_:1},8,["onClick"])):(f(),C(k,{key:0,color:"error",size:"large",loading:s.loading.upload,class:"ml-2",onClick:i.manualUpload},{default:a(()=>[...e[26]||(e[26]=[r(" 上传 ",-1)])]),_:1},8,["loading","onClick"])),i.showRandomPickerButton?(f(),C(k,{key:2,color:"amber","prepend-icon":"mdi-account-question","append-icon":"mdi-dice-multiple",size:"large",class:"ml-2",onClick:i.openRandomPicker},{default:a(()=>[...e[28]||(e[28]=[r(" 随机点名 ",-1)])]),_:1},8,["onClick"])):_("",!0),i.showExamScheduleButton?(f(),C(k,{key:3,color:"green","prepend-icon":"mdi-calendar-check",size:"large",class:"ml-2",onClick:e[4]||(e[4]=h=>t.$router.push("/examschedule"))},{default:a(()=>[...e[29]||(e[29]=[r(" 考试看板 ",-1)])]),_:1})):_("",!0),i.showListCardButton?(f(),C(k,{key:4,color:"primary-darken-1","prepend-icon":"mdi-list-box",size:"large",class:"ml-2",onClick:e[5]||(e[5]=h=>t.$router.push("/list"))},{default:a(()=>[...e[30]||(e[30]=[r(" 列表 ",-1)])]),_:1})):_("",!0),i.showFullscreenButton?(f(),C(k,{key:5,color:s.state.isFullscreen?"blue-grey":"blue","prepend-icon":s.state.isFullscreen?"mdi-fullscreen-exit":"mdi-fullscreen",size:"large",class:"ml-2",onClick:i.toggleFullscreen},{default:a(()=>[r(b(s.state.isFullscreen?"退出全屏":"全屏显示"),1)]),_:1},8,["color","prepend-icon","onClick"])):_("",!0),i.showAntiScreenBurnCard?(f(),C(L,{key:6,border:"",class:"mt-4 anti-burn-card",color:"primary",variant:"tonal"},{default:a(()=>[n(se,{class:"text-subtitle-1"},{default:a(()=>[n(T,{start:"",icon:"mdi-shield-check",size:"small"}),e[31]||(e[31]=r(" 屏幕保护技术已启用 ",-1))]),_:1}),n(Y,{class:"text-body-2"},{default:a(()=>[...e[32]||(e[32]=[o("p",null," 本应用采用独立自研的动态像素偏移技术(DPO™)，有效防止LCD屏幕烧屏现象。 ",-1),o("p",{class:"text-caption text-grey"},[r(" *研究显示动态像素偏移技术可以修复屏幕坏点，起到保护屏幕的作用，数据来自实验室。"),o("a",{href:"https://patentscope.wipo.int/search/zh/detail.jsf?docId=CN232281523&_cid=P20-M8L0YX-67061-1",target:"_blank"},"专利号CN108648692 ")],-1),o("p",{class:"text-caption text-grey"}," *技术已自动适配您的设备，无需手动调整 ",-1)])]),_:1})]),_:1})):_("",!0)]),_:1}),s.state.studentList&&s.state.studentList.length?ee((f(),C(xe,{key:0,class:"attendance-area no-select",cols:"1",onClick:e[6]||(e[6]=h=>i.setAttendanceArea())},{default:a(()=>[e[43]||(e[43]=o("h1",null,"出勤",-1)),o("h2",null,[n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[...e[33]||(e[33]=[r(" 应到 ",-1)])]),_:1}),e[34]||(e[34]=r(": ",-1)),n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[r(b(s.state.studentList.length-s.state.boardData.attendance.exclude.length)+"人 ",1)]),_:1})]),o("h2",null,[n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[...e[35]||(e[35]=[r(" 实到 ",-1)])]),_:1}),e[36]||(e[36]=r(": ",-1)),n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[r(b(s.state.studentList.length-s.state.boardData.attendance.absent.length-s.state.boardData.attendance.late.length-s.state.boardData.attendance.exclude.length)+"人 ",1)]),_:1})]),o("h2",null,[n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[...e[37]||(e[37]=[r(" 请假 ",-1)])]),_:1}),e[38]||(e[38]=r(": ",-1)),n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[r(b(s.state.boardData.attendance.absent.length)+"人 ",1)]),_:1})]),(f(!0),x(z,null,O(s.state.boardData.attendance.absent,(h,N)=>(f(),x("h3",{class:"gray-text",key:"absent-"+N},[s.useDisplay().lgAndUp.value?(f(),x("span",Xa,b(`${N+1}. `),1)):_("",!0),o("span",Za,b(h),1)]))),128)),o("h2",null,[n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[...e[39]||(e[39]=[r("迟到",-1)])]),_:1}),e[40]||(e[40]=r(": ",-1)),n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[r(b(s.state.boardData.attendance.late.length)+"人 ",1)]),_:1})]),(f(!0),x(z,null,O(s.state.boardData.attendance.late,(h,N)=>(f(),x("h3",{class:"gray-text",key:"late-"+N},[s.useDisplay().lgAndUp.value?(f(),x("span",el,b(`${N+1}. `),1)):_("",!0),o("span",tl,b(h),1)]))),128)),o("h2",null,[n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[...e[41]||(e[41]=[r("不参与",-1)])]),_:1}),e[42]||(e[42]=r(": ",-1)),n(p,{style:{"white-space":"nowrap"}},{default:a(()=>[r(b(s.state.boardData.attendance.exclude.length)+"人 ",1)]),_:1})]),(f(!0),x(z,null,O(s.state.boardData.attendance.exclude,(h,N)=>(f(),x("h3",{class:"gray-text",key:"exclude-"+N},[s.useDisplay().lgAndUp.value?(f(),x("span",sl,b(`${N+1}. `),1)):_("",!0),o("span",nl,b(h),1)]))),128))]),_:1})),[[ke,{class:`text-${["primary","secondary","info","success","warning","error"][Math.floor(Math.random()*6)]}`}]]):_("",!0)])),n(v,{modelValue:s.state.dialogVisible,"onUpdate:modelValue":e[7]||(e[7]=h=>s.state.dialogVisible=h),title:s.state.dialogTitle,"initial-content":s.state.textarea,"auto-save":i.autoSave,onSave:i.handleHomeworkSave},null,8,["modelValue","title","initial-content","auto-save","onSave"]),n(Vs,{modelValue:s.state.snackbar,"onUpdate:modelValue":e[8]||(e[8]=h=>s.state.snackbar=h),timeout:2e3},{default:a(()=>[r(b(s.state.snackbarText),1)]),_:1},8,["modelValue"]),n(de,{modelValue:s.state.attendanceDialog,"onUpdate:modelValue":[e[14]||(e[14]=h=>s.state.attendanceDialog=h),i.handleAttendanceDialogClose],"max-width":"900","fullscreen-breakpoint":"sm"},{default:a(()=>[n(L,null,{default:a(()=>[n(se,{class:"d-flex align-center"},{default:a(()=>[n(T,{icon:"mdi-account-group",class:"mr-2"}),e[44]||(e[44]=r(" 出勤状态管理 ",-1)),n(ne),n(q,{color:"primary",size:"small",class:"ml-2"},{default:a(()=>[r(b(s.state.dateString),1)]),_:1})]),_:1}),n(Y,null,{default:a(()=>[n(Pe,{class:"mb-4"},{default:a(()=>[n(xe,{cols:"12",md:"12"},{default:a(()=>[n(ve,{modelValue:s.attendanceSearch,"onUpdate:modelValue":[e[9]||(e[9]=h=>s.attendanceSearch=h),t.handleSearchChange],"prepend-inner-icon":"mdi-magnify",label:"搜索学生",hint:"支持筛选姓氏，如输入'孙'可筛选所有姓孙的学生",variant:"outlined",clearable:""},null,8,["modelValue","onUpdate:modelValue"]),o("div",al,[(f(!0),x(z,null,O(i.extractedSurnames,h=>(f(),C(k,{key:h.name,variant:s.attendanceSearch===h.name?"elevated":"text",color:s.attendanceSearch===h.name?"primary":"",onClick:N=>s.attendanceSearch=s.attendanceSearch===h.name?"":h.name},{default:a(()=>[r(b(h.name)+" ("+b(h.count)+") ",1)]),_:2},1032,["variant","color","onClick"]))),128))])]),_:1})]),_:1}),o("div",ll,[o("div",null,[n(q,{value:"present",color:s.attendanceFilter.includes("present")?"success":"",variant:s.attendanceFilter.includes("present")?"elevated":"tonal",class:"px-2 filter-chip",onClick:e[10]||(e[10]=h=>i.toggleFilter("present")),"prepend-icon":"mdi-account-check","append-icon":s.attendanceFilter.includes("present")?"mdi-check":""},{default:a(()=>[...e[45]||(e[45]=[r(" 到课 ",-1)])]),_:1},8,["color","variant","append-icon"]),n(q,{value:"absent",color:s.attendanceFilter.includes("absent")?"error":"",variant:s.attendanceFilter.includes("absent")?"elevated":"tonal",class:"px-2 filter-chip",onClick:e[11]||(e[11]=h=>i.toggleFilter("absent")),"prepend-icon":"mdi-account-off","append-icon":s.attendanceFilter.includes("absent")?"mdi-check":""},{default:a(()=>[...e[46]||(e[46]=[r(" 请假 ",-1)])]),_:1},8,["color","variant","append-icon"]),n(q,{value:"late",color:s.attendanceFilter.includes("late")?"warning":"",variant:s.attendanceFilter.includes("late")?"elevated":"tonal",class:"px-2 filter-chip",onClick:e[12]||(e[12]=h=>i.toggleFilter("late")),"prepend-icon":"mdi-clock-alert","append-icon":s.attendanceFilter.includes("late")?"mdi-check":""},{default:a(()=>[...e[47]||(e[47]=[r(" 迟到 ",-1)])]),_:1},8,["color","variant","append-icon"]),n(q,{value:"exclude",color:s.attendanceFilter.includes("exclude")?"grey":"",variant:s.attendanceFilter.includes("exclude")?"elevated":"tonal",class:"px-2 filter-chip",onClick:e[13]||(e[13]=h=>i.toggleFilter("exclude")),"prepend-icon":"mdi-account-cancel","append-icon":s.attendanceFilter.includes("exclude")?"mdi-check":""},{default:a(()=>[...e[48]||(e[48]=[r(" 不参与 ",-1)])]),_:1},8,["color","variant","append-icon"])])]),n(Pe,null,{default:a(()=>[(f(!0),x(z,null,O(i.filteredStudents,h=>(f(),C(xe,{key:h,cols:"12",sm:"6",md:"6",lg:"4"},{default:a(()=>[n(L,{class:"student-card",border:""},{default:a(()=>[n(Y,{class:"d-flex align-center pa-2"},{default:a(()=>[o("div",il,[o("div",ol,[n(Ge,{color:i.getStudentStatusColor(s.state.studentList.indexOf(h)),size:"24",class:"mr-2"},{default:a(()=>[n(T,{size:"small"},{default:a(()=>[r(b(i.getStudentStatusIcon(s.state.studentList.indexOf(h))),1)]),_:2},1024)]),_:2},1032,["color"]),o("div",rl,b(h),1)])]),o("div",dl,[n(k,{color:i.isPresent(s.state.studentList.indexOf(h))?"success":"",icon:"mdi-account-check",size:"small",variant:"text",onClick:N=>i.setPresent(s.state.studentList.indexOf(h)),title:"设为到课"},null,8,["color","onClick"]),n(k,{color:i.isAbsent(s.state.studentList.indexOf(h))?"error":"",icon:"mdi-account-off",size:"small",variant:"text",onClick:N=>i.setAbsent(s.state.studentList.indexOf(h)),title:"设为请假"},null,8,["color","onClick"]),n(k,{color:i.isLate(s.state.studentList.indexOf(h))?"warning":"",icon:"mdi-clock-alert",size:"small",variant:"text",onClick:N=>i.setLate(s.state.studentList.indexOf(h)),title:"设为迟到"},null,8,["color","onClick"]),n(k,{color:i.isExclude(s.state.studentList.indexOf(h))?"grey":"",icon:"mdi-account-cancel",size:"small",variant:"text",onClick:N=>i.setExclude(s.state.studentList.indexOf(h)),title:"设为不参与"},null,8,["color","onClick"])])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),n(Pe,null,{default:a(()=>[n(xe,{cols:"12",md:"12"},{default:a(()=>[n(L,{variant:"tonal",color:"primary",class:"mb-4"},{default:a(()=>[n(Y,null,{default:a(()=>[e[53]||(e[53]=o("div",{class:"text-subtitle-2 mb-2"},"批量操作",-1)),n(Ie,null,{default:a(()=>[n(k,{color:"success","prepend-icon":"mdi-account-check",onClick:i.setAllPresent},{default:a(()=>[...e[49]||(e[49]=[r(" 全部到齐 ",-1)])]),_:1},8,["onClick"]),n(k,{color:"error","prepend-icon":"mdi-account-off",onClick:i.setAllAbsent},{default:a(()=>[...e[50]||(e[50]=[r(" 全部请假 ",-1)])]),_:1},8,["onClick"])]),_:1}),n(Ie,null,{default:a(()=>[n(k,{color:"warning","prepend-icon":"mdi-clock-alert",onClick:i.setAllLate},{default:a(()=>[...e[51]||(e[51]=[r(" 全部迟到 ",-1)])]),_:1},8,["onClick"]),n(k,{color:"grey","prepend-icon":"mdi-account-cancel",onClick:i.setAllExclude},{default:a(()=>[...e[52]||(e[52]=[r(" 全部不参与 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),n(Se),n(fe,null,{default:a(()=>[n(ne),n(k,{color:"primary",onClick:i.saveAttendance},{default:a(()=>[n(T,{start:""},{default:a(()=>[...e[54]||(e[54]=[r("mdi-content-save",-1)])]),_:1}),e[55]||(e[55]=r(" 保存 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onUpdate:modelValue"]),n(y,{ref:"messageLog"},null,512),n(D,{loading:s.loading.download,"unread-count":i.unreadCount,"selected-date":s.state.selectedDateObj,"is-today":i.isToday,onZoom:i.zoom,onRefresh:i.downloadData,onOpenMessages:e[15]||(e[15]=h=>t.$refs.messageLog.drawer=!0),onOpenSettings:e[16]||(e[16]=h=>t.$router.push("/settings")),onDateSelect:i.handleDateSelect,onPrevDay:e[17]||(e[17]=h=>i.navigateDay(-1)),onNextDay:e[18]||(e[18]=h=>i.navigateDay(1))},null,8,["loading","unread-count","selected-date","is-today","onZoom","onRefresh","onDateSelect"]),n(d),n(B,{modelValue:s.isChatOpen,"onUpdate:modelValue":e[19]||(e[19]=h=>s.isChatOpen=h),"show-button":!1},null,8,["modelValue"]),n(de,{modelValue:s.confirmDialog.show,"onUpdate:modelValue":e[20]||(e[20]=h=>s.confirmDialog.show=h),"max-width":"400"},{default:a(()=>[n(L,null,{default:a(()=>[n(se,{class:"text-h6"},{default:a(()=>[...e[56]||(e[56]=[r(" 确认保存 ",-1)])]),_:1}),n(Y,null,{default:a(()=>[r(" 您正在修改 "+b(s.state.dateString)+" 的数据，确定要保存吗？ ",1)]),_:1}),n(fe,null,{default:a(()=>[n(ne),n(k,{color:"grey",variant:"text",onClick:s.confirmDialog.reject},{default:a(()=>[...e[57]||(e[57]=[r(" 取消 ",-1)])]),_:1},8,["onClick"]),n(k,{color:"primary",onClick:s.confirmDialog.resolve},{default:a(()=>[...e[58]||(e[58]=[r(" 确认保存 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(Q,{ref:"randomPicker","student-list":s.state.studentList,attendance:s.state.boardData.attendance},null,8,["student-list","attendance"]),n(de,{modelValue:s.urlConfigDialog.show,"onUpdate:modelValue":e[21]||(e[21]=h=>s.urlConfigDialog.show=h),"max-width":"500"},{default:a(()=>[n(L,null,{default:a(()=>[n(se,{class:"text-h6"},{default:a(()=>[...e[59]||(e[59]=[r(" 确认应用URL配置 ",-1)])]),_:1}),n(Y,null,{default:a(()=>[e[60]||(e[60]=o("p",null,"以下配置将应用于当前班级：",-1)),n(Ke,{density:"compact"},{default:a(()=>[(f(!0),x(z,null,O(s.urlConfigDialog.changes,h=>(f(),C(Ae,{key:h.key},{prepend:a(()=>[n(T,{icon:h.icon,size:"small",class:"mr-2"},null,8,["icon"])]),default:a(()=>[n(Ts,{class:"d-flex align-center"},{default:a(()=>[o("span",ul,b(h.name),1),n(We,{activator:"parent",location:"top"},{default:a(()=>[r(b(h.description||h.key),1)]),_:2},1024)]),_:2},1024),n(_s,null,{default:a(()=>[o("span",cl,b(h.oldValue),1),n(T,{icon:"mdi-arrow-right",size:"small",class:"mx-1"}),o("span",ml,b(h.newValue),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),n(fe,null,{default:a(()=>[n(ne),n(k,{color:"grey",variant:"text",onClick:s.urlConfigDialog.cancelHandler},{default:a(()=>[...e[61]||(e[61]=[r(" 取消 ",-1)])]),_:1},8,["onClick"]),n(k,{color:"primary",onClick:s.urlConfigDialog.confirmHandler},{default:a(()=>[...e[62]||(e[62]=[r(" 确认应用 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e[63]||(e[63]=o("br",null,null,-1)),e[64]||(e[64]=o("br",null,null,-1)),e[65]||(e[65]=o("br",null,null,-1)),e[66]||(e[66]=o("br",null,null,-1)),e[67]||(e[67]=o("br",null,null,-1)),e[68]||(e[68]=o("br",null,null,-1))],64)}const Al=ue(Ga,[["render",fl]]);export{Al as default};
